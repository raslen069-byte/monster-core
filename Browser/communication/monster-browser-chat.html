<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monster Browser - Secure Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <style>
        :root {
            --primary-color: #8b0000; /* Dark red horror theme */
            --primary-dark: #4b0000; /* Darker red */
            --secondary-color: #6c757d; /* Gray */
            --success-color: #0be881;
            --danger-color: #ff4757;
            --warning-color: #ffa502;
            --info-color: #0abde3;
            --light-bg: #f7f9fc; /* Elegant light background */
            --dark-bg: #0d0000; /* Darker red-black background */
            --chat-bg: #1a0000; /* Dark red chat background */
            --white: #ffffff; /* Pure white */
            --text: #ff5555; /* Blood red text */
            --gray-100: #f8f9fa;
            --gray-200: #e9ecef;
            --gray-300: #dee2e6;
            --gray-400: #ced4da;
            --gray-500: #adb5bd;
            --gray-600: #6c757d;
            --gray-700: #495057;
            --gray-800: #343a40;
            --gray-900: #212529;
            --border-radius: 16px;
            --shadow: 0 10px 30px rgba(0,0,0,0.08);
            --transition: all 0.3s ease;
            --gradient-primary: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background:
                linear-gradient(rgba(10, 0, 0, 0.9), rgba(5, 0, 0, 0.95)),
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 2px,
                    rgba(80, 0, 0, 0.1) 2px,
                    rgba(80, 0, 0, 0.1) 4px
                ),
                linear-gradient(135deg, #0d0000, #000000);
            min-height: 100vh;
            background-attachment: fixed;
            overflow: hidden;
            color: var(--text);
        }

        .container {
            max-width: 100%;
            margin: 0;
            background:
                linear-gradient(rgba(30, 0, 0, 0.5), rgba(10, 0, 0, 0.7)),
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 2px,
                    rgba(100, 0, 0, 0.1) 2px,
                    rgba(100, 0, 0, 0.1) 4px
                ),
                linear-gradient(to bottom, #220000, #000000);
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100vh;
            border: 2px solid #8b0000;
            position: relative;
        }

        .header {
            background:
                linear-gradient(rgba(30, 0, 0, 0.8), rgba(10, 0, 0, 0.9)),
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 5px,
                    rgba(80, 0, 0, 0.1) 5px,
                    rgba(80, 0, 0, 0.1) 10px
                ),
                linear-gradient(to bottom, #222, #000);
            color: var(--white);
            padding: 18px 25px;
            text-align: center;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid #ff0000;
            flex-shrink: 0;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5), inset 0 0 10px rgba(0, 0, 0, 0.8);
            animation: horrorScan 4s linear infinite;
        }

        .header::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background: linear-gradient(90deg, transparent, #ff0000, #ff5555, #ff0000, transparent);
            animation: horrorScan 4s linear infinite;
            opacity: 0.8;
        }

        @keyframes horrorScan {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .header-content {
            flex: 1;
        }

        .header h1 {
            font-size: 1.6rem;
            margin-bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-weight: 600;
        }

        .header h1 i {
            color: #ffd700;
            font-size: 1.3rem;
        }

        .header p {
            font-size: 0.9rem;
            opacity: 0.9;
            font-weight: 300;
            margin: 0;
        }

        .status-indicator {
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 6px 12px;
            border-radius: 20px;
            color: var(--white);
            font-size: 0.85rem;
            font-weight: bold;
        }

        .online {
            background-color: var(--success-color);
        }

        .offline {
            background-color: var(--danger-color);
        }

        .main-content {
            display: flex;
            flex-direction: column;
            flex: 1 1 auto; /* Allow it to grow/shrink */
            overflow: hidden;
            height: calc(100vh - 60px); /* Account for header - use viewport height */
            position: relative; /* Ensure children can be positioned properly */
        }

        .chat-area {
            display: flex;
            flex-direction: column;
            flex: 1 1 auto;
            background:
                linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.9)),
                repeating-radial-gradient(
                    circle at 15% 25%, rgba(139, 0, 0, 0.05) 0%, transparent 3%
                ),
                repeating-radial-gradient(
                    circle at 85% 75%, rgba(139, 0, 0, 0.05) 0%, transparent 3%
                ),
                #000;
            overflow: hidden;
            min-height: 0;
            order: 1;
            height: 100%;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 25px;
            padding-bottom: 20px;
            background:
                linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.9)),
                repeating-radial-gradient(
                    circle at 15% 25%, rgba(139, 0, 0, 0.05) 0%, transparent 3%
                ),
                repeating-radial-gradient(
                    circle at 85% 75%, rgba(139, 0, 0, 0.05) 0%, transparent 3%
                ),
                #000;
            display: flex;
            flex-direction: column;
            gap: 18px;
            position: relative;
            min-height: 0;
            scroll-behavior: smooth;
        }

        /* Custom scrollbar for chat container */
        .chat-container::-webkit-scrollbar {
            width: 8px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 4px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: rgba(139, 0, 0, 0.5);
            border-radius: 4px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: rgba(139, 0, 0, 0.7);
        }

        .chat-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 10% 20%, rgba(139, 0, 0, 0.05) 0%, transparent 3%),
                radial-gradient(circle at 90% 80%, rgba(139, 0, 0, 0.05) 0%, transparent 3%),
                radial-gradient(circle at 50% 10%, rgba(139, 0, 0, 0.05) 0%, transparent 3%);
            pointer-events: none;
            z-index: 1;
        }

        .message {
            margin-bottom: 15px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            max-width: 75%;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            position: relative;
            animation: fadeIn 0.3s ease;
            height: auto;
            min-height: auto;
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            background:
                linear-gradient(rgba(30, 0, 0, 0.4), rgba(10, 0, 0, 0.6)),
                linear-gradient(to bottom, #220000, #110000);
            color: var(--white);
            margin-left: auto;
            text-align: left;
            border-radius: 18px 18px 4px 18px;
            padding: 15px 20px;
            max-width: 75%;
            box-shadow: 0 4px 12px rgba(139, 0, 0, 0.3);
            position: relative;
            overflow: visible;
            border-left: 4px solid #ff0000;
            text-shadow: 0 0 5px rgba(255, 0, 0, 0.3);
        }

        .message.sent::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, #0be881, #01a368);
        }

        .message.received {
            background:
                linear-gradient(rgba(40, 0, 0, 0.4), rgba(20, 0, 0, 0.6)),
                linear-gradient(to bottom, #440000, #220000);
            color: var(--white);
            margin-right: auto;
            border-radius: 18px 18px 18px 4px;
            padding: 15px 20px;
            max-width: 75%;
            box-shadow: 0 4px 12px rgba(139, 0, 0, 0.2);
            border: 1px solid rgba(139, 0, 0, 0.3);
            position: relative;
            overflow: visible;
            border-right: 4px solid #ff5555;
            text-shadow: 0 0 5px rgba(255, 85, 85, 0.3);
        }

        .message.received::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(to bottom, #ffdd59, #ff9f1a);
        }

        .message.system {
            background:
                linear-gradient(rgba(30, 0, 0, 0.4), rgba(10, 0, 0, 0.6)),
                linear-gradient(to bottom, #220000, #110000);
            color: #ff5555;
            text-align: center;
            font-style: italic;
            max-width: 100%;
            margin: 10px auto;
            border-radius: 20px;
            padding: 12px 20px;
            box-shadow: 0 4px 12px rgba(139, 0, 0, 0.3);
            border: 1px solid rgba(139, 0, 0, 0.5);
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            overflow: visible;
            height: auto;
        }

        .message-header {
            font-size: 0.85rem;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            flex-wrap: wrap;
        }

        .message.sent .message-header {
            color: rgba(255, 255, 255, 0.9);
        }

        .message.received .message-header {
            color: var(--gray-600);
        }

        .message-content {
            font-size: 1rem;
            line-height: 1.6;
            word-wrap: break-word;
            word-break: break-word;
            overflow-wrap: break-word;
            white-space: normal;
            display: block;
        }

        .message-content a {
            color: #4fc3f7;
            text-decoration: underline;
            word-break: break-all;
            overflow-wrap: break-word;
        }

        .username {
            color: var(--gray-800);
        }

        .message-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .timestamp {
            color: inherit;
        }

        .datestamp {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.65rem;
        }

        .message.sent .message-meta {
            color: rgba(255, 255, 255, 0.8);
        }

        .message.received .message-meta {
            color: var(--gray-600);
        }

        .message-reactions {
            display: flex;
            gap: 6px;
            margin-top: 12px;
            justify-content: flex-end;
            flex-wrap: wrap;
            align-items: center;
        }

        .reaction {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 14px;
            padding: 4px 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid rgba(255,255,255,0.4);
            white-space: nowrap;
        }

        .message.sent .reaction {
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255,255,255,0.5);
        }

        .message.received .reaction {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0,0,0,0.1);
        }

        .reaction:hover {
            transform: scale(1.2);
            background: rgba(255, 255, 255, 0.6);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message-status {
            margin-left: 5px;
            font-size: 0.7rem;
            color: #0be881;
        }

        .input-area {
            padding: 10px 15px;
            display: flex;
            border-top: 2px solid #8b0000;
            background:
                linear-gradient(rgba(30, 0, 0, 0.5), rgba(10, 0, 0, 0.7)),
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 2px,
                    rgba(100, 0, 0, 0.1) 2px,
                    rgba(100, 0, 0, 0.1) 4px
                ),
                linear-gradient(to bottom, #220000, #000000);
            gap: 8px;
            align-items: center;
            flex-direction: column;
            min-height: 80px;
            flex-shrink: 0;
            flex-grow: 0;
            order: 2;
            width: 100%;
            box-sizing: border-box;
            position: relative;
            z-index: 100;
        }

        .emoji-option {
            cursor: pointer;
            font-size: 1.2rem;
            text-align: center;
            padding: 5px;
            border-radius: 5px;
            transition: var(--transition);
        }

        .emoji-option:hover {
            background-color: var(--gray-200);
            transform: scale(1.2);
        }

        .selected {
            background: var(--primary-color) !important;
            color: white !important;
        }

        /* Creative message animations */
        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .message {
            animation: messageAppear 0.3s ease-out forwards;
        }

        /* Bubble tail effect */
        .message.sent {
            border-top-right-radius: 0;
        }

        .message.received {
            border-top-left-radius: 0;
        }

        /* Gradient borders */
        .message.sent {
            border: 1px solid rgba(74, 111, 165, 0.3);
        }

        .message.received {
            border: 1px solid rgba(230, 240, 255, 0.5);
        }

        /* Special effects for system messages */
        .message.system {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(139, 0, 0, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(139, 0, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(139, 0, 0, 0); }
        }

        /* Starting animation */
        .container {
            opacity: 0;
            transform: scale(0.8);
            animation: entranceAnimation 1.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) 0.2s forwards;
        }

        @keyframes entranceAnimation {
            0% {
                opacity: 0;
                transform: scale(0.8) rotateX(90deg);
            }
            30% {
                opacity: 0.7;
                transform: scale(1.05) rotateX(0deg);
            }
            70% {
                opacity: 0.9;
                transform: scale(0.95);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Ensure container remains visible after animation */
        .container.animation-complete {
            opacity: 1 !important;
            transform: scale(1) !important;
        }

        /* Floating elements animation */
        .header {
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
            100% {
                transform: translateY(0px);
            }
        }

        /* Pulsing effect for messages */
        .message {
            animation: messageAppear 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        /* Breathing effect for scary messages */
        .message.system {
            animation: pulse 2s infinite, messageAppear 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        @keyframes breathing {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }

        /* Enhanced glow effect */
        .glow {
            animation: glowEffect 2s infinite alternate;
        }

        @keyframes glowEffect {
            from {
                box-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
            }
            to {
                box-shadow: 0 0 20px rgba(255, 0, 0, 0.8), 0 0 30px rgba(255, 0, 0, 0.6);
            }
        }

        /* Typing indicator animation */
        .typing-indicator {
            animation: typingPulse 1.5s infinite;
        }

        @keyframes typingPulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        /* Contact item hover animation */
        .contact-item {
            transition: all 0.3s ease;
        }

        .contact-item:hover {
            transform: translateY(-5px) scale(1.02);
            animation: shake 0.5s;
        }

        @keyframes shake {
            0% { transform: translateX(0); }
            25% { transform: translateX(-2px); }
            50% { transform: translateX(2px); }
            75% { transform: translateX(-2px); }
            100% { transform: translateX(0); }
        }

        /* Button press animation */
        .action-button:active,
        .send-button:active,
        .auth-button:active {
            animation: buttonPress 0.2s ease;
        }

        @keyframes buttonPress {
            0% { transform: scale(1); }
            50% { transform: scale(0.95); }
            100% { transform: scale(1); }
        }

        /* Spooky floating effect for emoji options */
        .emoji-option {
            animation: floatEmoji 3s ease-in-out infinite;
            animation-delay: calc(var(--i) * 0.1s);
        }

        @keyframes floatEmoji {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        /* Enhanced message arrival animation */
        @keyframes sentMessageAppear {
            0% {
                opacity: 0;
                transform: translateX(30px) scale(0.95);
            }
            70% {
                transform: translateX(-5px) scale(1.02);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        @keyframes receivedMessageAppear {
            0% {
                opacity: 0;
                transform: translateX(-30px) scale(0.95);
            }
            70% {
                transform: translateX(5px) scale(1.02);
            }
            100% {
                opacity: 1;
                transform: translateX(0) scale(1);
            }
        }

        .message.sent {
            animation: sentMessageAppear 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .message.received {
            animation: receivedMessageAppear 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Remove old ripple effect */

        /* Horror-inspired text effects */
        .horror-text {
            text-shadow:
                0 0 5px rgba(255, 0, 0, 0.7),
                0 0 10px rgba(255, 0, 0, 0.5),
                0 0 15px rgba(255, 0, 0, 0.3);
        }

        /* Blinking effect for notifications */
        .blink {
            animation: blink 1.5s step-start infinite;
        }

        @keyframes blink {
            50% { opacity: 0.3; }
        }

        .typing-indicator {
            width: 100%;
            text-align: center;
            margin-bottom: 10px;
            font-style: italic;
            color: var(--gray-600);
        }

        #messageInput {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #8b0000;
            border-radius: 50px;
            font-size: 1rem;
            transition: var(--transition);
            background:
                linear-gradient(rgba(20, 0, 0, 0.5), rgba(10, 0, 0, 0.7)),
                linear-gradient(to right, #110000, #220000);
            color: #ff5555;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            letter-spacing: 1px;
            text-shadow: 0 0 5px rgba(255, 0, 0, 0.5);
            box-shadow:
                inset 0 0 10px rgba(0, 0, 0, 0.8),
                0 0 10px rgba(255, 0, 0, 0.3);
        }

        #messageInput:focus {
            outline: none;
            border-color: #ff0000;
            box-shadow:
                inset 0 0 15px rgba(0, 0, 0, 0.8),
                0 0 20px rgba(255, 0, 0, 0.8);
        }

        #messageInput::placeholder {
            color: #550000;
            opacity: 0.7;
            font-style: italic;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
        }

        .action-button {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background:
                linear-gradient(rgba(30, 0, 0, 0.8), rgba(10, 0, 0, 0.9)),
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 2px,
                    rgba(100, 0, 0, 0.1) 2px,
                    rgba(100, 0, 0, 0.1) 4px
                ),
                linear-gradient(to bottom, #220000, #000000);
            color: var(--white);
            border: 2px solid #8b0000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: var(--transition);
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        }

        .action-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);
            background:
                linear-gradient(rgba(40, 0, 0, 0.9), rgba(20, 0, 0, 1)),
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 2px,
                    rgba(120, 0, 0, 0.2) 2px,
                    rgba(120, 0, 0, 0.2) 4px
                ),
                linear-gradient(to bottom, #330000, #110000);
        }

        .action-button:active {
            transform: scale(0.95);
        }

        .send-button {
            width: auto;
            padding: 15px 25px;
            border-radius: 50px;
            background:
                linear-gradient(rgba(30, 0, 0, 0.8), rgba(10, 0, 0, 0.9)),
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 2px,
                    rgba(100, 0, 0, 0.1) 2px,
                    rgba(100, 0, 0, 0.1) 4px
                ),
                linear-gradient(to bottom, #220000, #000000);
            color: var(--white);
            border: 2px solid #8b0000;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.3);
        }

        .send-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
            background:
                linear-gradient(rgba(40, 0, 0, 0.9), rgba(20, 0, 0, 1)),
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 2px,
                    rgba(120, 0, 0, 0.2) 2px,
                    rgba(120, 0, 0, 0.2) 4px
                ),
                linear-gradient(to bottom, #330000, #110000);
        }

        .send-button:active {
            transform: translateY(0);
        }

        .login-form {
            padding: 30px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex: 1;
            background: linear-gradient(135deg, #0a0a0a 0%, #121212 100%);
        }

        .form-container {
            width: 100%;
            max-width: 450px;
            background: #1a1a1a;
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid #444;
        }

        .form-header {
            margin-bottom: 25px;
        }

        .form-header h2 {
            color: #ff0000;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .form-header p {
            color: #999;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .form-group input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #444;
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
            background-color: #222;
            color: var(--white);
        }

        .form-group input:focus {
            outline: none;
            border-color: #8b0000;
            box-shadow: 0 0 0 3px rgba(139, 0, 0, 0.3);
        }

        .auth-buttons {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .auth-button {
            flex: 1;
            padding: 14px 20px;
            background: linear-gradient(135deg, #8b0000 0%, #4b0000 100%);
            color: var(--white);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.6);
            background: linear-gradient(135deg, #a00000 0%, #600000 100%);
        }

        .auth-button:active {
            transform: translateY(0);
        }

        .auth-button.secondary {
            background: linear-gradient(135deg, var(--secondary-color) 0%, #5a6268 100%);
        }

        .contacts-panel {
            width: 280px;
            background-color: white;
            border-left: 1px solid #eee;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: -5px 0 15px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }

        .panel-header {
            padding: 18px 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-controls {
            display: flex;
            gap: 10px;
        }

        .panel-control-btn {
            background: rgba(139, 0, 0, 0.3);
            border: none;
            color: var(--white);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .panel-control-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: var(--white);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .panel-control-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* Collapsible Friends Menu */
        .friends-menu-toggle {
            position: fixed;
            top: 50%;
            right: 20px;
            transform: translateY(-50%);
            background:
                linear-gradient(rgba(30, 0, 0, 0.8), rgba(10, 0, 0, 0.9)),
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 2px,
                    rgba(100, 0, 0, 0.1) 2px,
                    rgba(100, 0, 0, 0.1) 4px
                ),
                linear-gradient(to bottom, #220000, #000000);
            color: white;
            border: 2px solid #8b0000;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 0 15px rgba(139, 0, 0, 0.5);
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .friends-menu-toggle:hover {
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 0 20px rgba(139, 0, 0, 0.8);
        }

        /* Profile Card Styles - Always Visible at Top of Friends Menu */
        .profile-card {
            background: linear-gradient(135deg, rgba(139, 0, 0, 0.4), rgba(75, 0, 0, 0.5));
            padding: 20px;
            border-bottom: 2px solid #ff0000;
            display: flex;
            align-items: center;
            gap: 15px;
            flex-shrink: 0;
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.3);
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700, #ff8c00);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8em;
            color: #000;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            flex-shrink: 0;
        }

        .profile-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .profile-label {
            font-size: 0.85em;
            color: #aaa;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .profile-id-display {
            font-size: 1.4em;
            font-weight: bold;
            color: #ffd700;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            background: rgba(0, 0, 0, 0.4);
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #ffd700;
            text-align: center;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.5);
        }

        .copy-id-btn {
            background: linear-gradient(135deg, #4CAF50, #2E7D32);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .copy-id-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.5);
            background: linear-gradient(135deg, #66BB6A, #43A047);
        }

        .copy-id-btn:active {
            transform: translateY(0);
        }

        .copy-id-btn i {
            font-size: 0.9em;
        }

        .copy-feedback {
            display: none;
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
            border-radius: 4px;
            padding: 6px 10px;
            color: #4CAF50;
            font-size: 0.85em;
            font-weight: bold;
            text-align: center;
            animation: fadeIn 0.3s ease;
        }

        .copy-feedback.show {
            display: block;
        }

        .friends-menu {
            position: fixed;
            top: 50%;
            right: -320px; /* Initially hidden */
            transform: translateY(-50%);
            width: 300px;
            height: 70vh;
            background:
                linear-gradient(rgba(30, 0, 0, 0.8), rgba(10, 0, 0, 0.9)),
                repeating-linear-gradient(
                    circle at 15% 25%, rgba(139, 0, 0, 0.05) 0%, transparent 3%
                ),
                repeating-linear-gradient(
                    circle at 85% 75%, rgba(139, 0, 0, 0.05) 0%, transparent 3%
                ),
                #000;
            border: 2px solid #8b0000;
            border-radius: 15px 0 0 15px;
            box-shadow: -10px 0 30px rgba(0,0,0,0.5);
            z-index: 1001;
            display: flex;
            flex-direction: column;
            transition: right 0.4s ease;
            overflow: hidden;
        }

        .friends-menu.open {
            right: 0; /* Slide in */
        }

        .friends-menu-header {
            padding: 18px 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #8b0000;
        }

        .friends-menu-header h3 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-friends-menu {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-friends-menu:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .quick-join-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .quick-join-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .friends-menu-tabs {
            display: flex;
            background-color: rgba(139, 0, 0, 0.2);
        }

        .friends-menu-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-600);
            transition: var(--transition);
            border-bottom: 3px solid transparent;
        }

        .friends-menu-tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background-color: rgba(74, 111, 165, 0.1);
        }

        .friends-menu-tab:hover:not(.active) {
            background-color: var(--gray-200);
        }

        .friends-menu-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px 15px;
            background-color: rgba(0, 0, 0, 0.3);
        }

        /* Responsive adjustments for friends menu */
        @media (max-width: 992px) {
            .friends-menu {
                width: 280px;
                right: -280px;
            }
        }

        @media (max-width: 768px) {
            .friends-menu {
                width: 250px;
                right: -250px;
                height: 60vh;
            }

            .friends-menu-toggle {
                width: 45px;
                height: 45px;
                font-size: 1rem;
            }
        }

        @media (max-width: 576px) {
            .friends-menu {
                width: 220px;
                right: -220px;
                height: 50vh;
            }

            .friends-menu-toggle {
                width: 40px;
                height: 40px;
                font-size: 0.9rem;
                right: 10px;
            }
        }

        .panel-tabs {
            display: flex;
            background-color: #1a1a1a;
        }

        .panel-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            color: var(--gray-600);
            transition: var(--transition);
            border-bottom: 3px solid transparent;
        }

        .panel-tab.active {
            color: var(--primary-color);
            border-bottom: 3px solid var(--primary-color);
            background-color: rgba(74, 111, 165, 0.1);
        }

        .panel-tab:hover:not(.active) {
            background-color: var(--gray-200);
        }

        .contacts-list {
            flex: 1;
            overflow-y: auto;
            padding: 20px 15px;
            background-color: white;
        }

        .contact-item {
            padding: 15px;
            margin: 10px 0;
            background-color: var(--white);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            border: 1px solid #eef2f7;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
        }

        .contact-item:hover {
            background-color: #f0f7ff;
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.08);
            border-color: #dae6f8;
        }

        .contact-item.selected {
            background: linear-gradient(135deg, #f0f7ff 0%, #e6f2ff 100%);
            border-color: var(--primary-color);
            box-shadow: 0 4px 15px rgba(106, 17, 203, 0.15);
            position: relative;
            overflow: hidden;
        }

        .contact-item.selected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 4px;
            background: var(--gradient-primary);
        }

        .contact-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--white);
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
            font-size: 1.1rem;
            box-shadow: 0 4px 10px rgba(106, 17, 203, 0.2);
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 3px;
        }

        .contact-status {
            display: flex;
            align-items: center;
            font-size: 0.85rem;
            color: var(--gray-600);
        }

        .status-indicator-small {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
            display: inline-block;
        }

        .status-online {
            background-color: var(--success-color);
        }

        .status-away {
            background-color: var(--warning-color);
        }

        .status-busy {
            background-color: var(--danger-color);
        }

        .status-offline {
            background-color: var(--secondary-color);
        }

        .hidden {
            display: none !important;
        }

        /* Friend Requests Section */
        .friend-requests-section {
            display: none;
            padding: 20px;
            background-color: var(--white);
            border-bottom: 1px solid var(--gray-300);
        }

        .friend-request-item {
            padding: 15px;
            margin: 10px 0;
            background-color: var(--gray-100);
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid var(--gray-300);
        }

        .request-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .request-actions {
            display: flex;
            gap: 10px;
        }

        .request-action-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
        }

        .accept-btn {
            background: var(--success-color);
            color: var(--white);
        }

        .decline-btn {
            background: var(--danger-color);
            color: var(--white);
        }

        .request-action-btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        /* Appearance Settings */
        .appearance-settings {
            display: none;
            padding: 20px;
            background-color: var(--white);
            border-bottom: 1px solid var(--gray-300);
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .setting-group {
            margin-bottom: 15px;
        }

        .setting-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-color);
        }

        .color-picker {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--gray-300);
            height: 50px;
        }

        .setting-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Improved Responsive adjustments */
        @media (max-width: 1100px) {
            .contacts-panel {
                width: 280px;
            }
        }

        @media (max-width: 992px) {
            .main-content {
                flex-direction: column;
            }

            .contacts-panel {
                width: 100%;
                height: 250px;
                border-left: none;
                border-top: 2px solid #8b0000;
                flex-shrink: 0;
                order: 2; /* Show contacts panel below chat on mobile */
            }

            .chat-area {
                order: 1; /* Show chat area above contacts on mobile */
                flex: 1;
            }

            .container {
                height: 100vh;
                flex-direction: column;
            }

            .header {
                width: 100%;
                box-sizing: border-box;
            }
        }

        @media (max-width: 768px) {
            .input-area {
                padding: 12px;
                min-height: auto;
            }

            .input-area > div {
                flex-wrap: wrap;
            }

            #messageInput {
                min-height: 45px;
                margin-bottom: 8px;
            }

            .action-buttons {
                width: 100%;
                justify-content: center;
            }

            .header h1 {
                font-size: 1.3rem;
            }

            .header p {
                font-size: 0.8rem;
            }

            .message {
                max-width: 90%;
                padding: 12px 16px;
            }

            .message.sent, .message.received {
                border-radius: 18px 18px 4px 18px;
            }
        }

        @media (max-width: 576px) {
            body {
                margin: 0;
                overflow-x: hidden;
            }

            .header {
                flex-direction: column;
                align-items: center;
                text-align: center;
                padding: 12px;
                gap: 5px;
            }

            .status-indicator {
                position: static;
                align-self: center;
                margin: 5px 0 0 0;
            }

            .input-area {
                flex-direction: column;
                padding: 10px;
                position: sticky;
                bottom: 0;
                background: var(--dark-bg);
            }

            .input-area > div {
                width: 100%;
                flex-wrap: nowrap;
            }

            #messageInput {
                flex: 1;
                margin: 0 5px 8px 0;
                min-height: 50px;
            }

            .action-buttons {
                width: 100%;
                justify-content: space-between;
                order: 2;
                margin-top: 8px;
            }

            .send-button {
                order: 3;
                width: 45px;
                height: 45px;
                margin-left: 5px;
            }

            .auth-buttons {
                flex-direction: column;
            }

            .message {
                max-width: 88%;
                padding: 10px 14px;
                font-size: 0.95rem;
            }

            .message-header {
                font-size: 0.8rem;
            }

            .message-content {
                font-size: 0.95rem;
            }

            .contacts-panel {
                height: 200px;
            }

            .panel-header {
                padding: 12px 15px;
                font-size: 0.95rem;
            }

            .contact-item {
                padding: 12px;
            }

            .contact-name {
                font-size: 0.95rem;
            }
        }

        @media (max-width: 400px) {
            .header h1 {
                font-size: 1.2rem;
            }

            .header h1 i {
                font-size: 1.1rem;
            }

            .message {
                max-width: 85%;
                padding: 9px 12px;
            }

            .input-area {
                padding: 8px;
            }

            #messageInput {
                min-height: 48px;
                padding: 10px 12px;
            }

            .action-button {
                width: 38px;
                height: 38px;
                font-size: 1rem;
            }

            .send-button {
                width: 38px;
                height: 38px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-content">
                <h1><i class="fas fa-skull"></i> Monster Browser - Secure Chat</h1>
                <p>Connect with other Monster Browser users worldwide</p>
            </div>
            <div id="statusIndicator" class="status-indicator offline">OFFLINE MODE</div>
        </div>

        <div id="loginForm" class="login-form">
            <div class="form-container">
                <div class="form-header">
                    <h2><i class="fas fa-user-circle"></i> Create Account or Sign In</h2>
                    <p>Join the Monster Browser community today!</p>
                </div>
                <div class="form-group">
                    <label for="username"><i class="fas fa-user"></i> Username:</label>
                    <input type="text" id="username" placeholder="Enter your username" required>
                </div>
                <div class="form-group">
                    <label for="email"><i class="fas fa-envelope"></i> Email:</label>
                    <input type="email" id="email" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="password"><i class="fas fa-lock"></i> Password:</label>
                    <input type="password" id="password" placeholder="Enter your password" required>
                </div>
                <div class="auth-buttons">
                    <button class="auth-button" onclick="createAccount()">
                        <i class="fas fa-user-plus"></i> Create Account
                    </button>
                    <button class="auth-button secondary" onclick="signIn()">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                </div>
            </div>
        </div>

        <div id="chatArea" class="hidden">
            <div class="main-content">
                <div class="chat-area">
                    <div class="appearance-settings" id="appearanceSettings">
                        <h3><i class="fas fa-palette"></i> Appearance Settings</h3>
                        <div class="settings-grid">
                            <div class="setting-group">
                                <label for="themeColor"><i class="fas fa-paint-brush"></i> Theme Color:</label>
                                <input type="color" id="themeColor" class="color-picker" value="#4a6fa5">
                            </div>
                            <div class="setting-group">
                                <label for="bgColor"><i class="fas fa-fill-drip"></i> Background Color:</label>
                                <input type="color" id="bgColor" class="color-picker" value="#f5f7fa">
                            </div>
                        </div>

                        <div class="settings-grid">
                            <!-- Enhanced Your Public ID Section -->
                            <div class="setting-group" style="background: linear-gradient(135deg, rgba(139, 0, 0, 0.3), rgba(75, 0, 0, 0.4)); padding: 20px; border-radius: 10px; border: 2px solid #8b0000; box-shadow: 0 4px 15px rgba(139, 0, 0, 0.3);">
                                <label style="font-size: 1.1em; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
                                    <i class="fas fa-id-card" style="color: #ffd700; font-size: 1.3em;"></i>
                                    <span style="color: #fff; font-weight: bold;">Your Public ID</span>
                                </label>
                                
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                    <div id="publicIdDisplay" 
                                         style="flex: 1; padding: 15px 20px; font-size: 1.5em; font-weight: bold; letter-spacing: 3px; text-align: center; border: 2px solid #ffd700; border-radius: 8px; background: linear-gradient(to bottom, #1a1a1a, #0a0a0a); color: #ffd700; font-family: 'Courier New', monospace; box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);">
                                        Loading...
                                    </div>
                                    <button class="auth-button" onclick="copyPublicId()" 
                                            style="padding: 15px 20px; font-size: 1.1em; min-width: 100px; background: linear-gradient(135deg, #4CAF50, #2E7D32);">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                </div>
                                
                                <div style="display: flex; gap: 10px; margin-top: 15px;">
                                    <button class="auth-button" onclick="refreshPublicId()" 
                                            style="flex: 1; padding: 10px; font-size: 0.9em; background: linear-gradient(135deg, #2196F3, #1976D2);">
                                        <i class="fas fa-sync"></i> Refresh ID
                                    </button>
                                </div>
                                
                                <p style="margin-top: 15px; font-size: 0.9em; color: #aaa; line-height: 1.6;">
                                    <i class="fas fa-info-circle" style="color: #4fc3f7;"></i> 
                                    Share this ID with friends so they can add you. This is your unique identifier in Monster Browser.
                                </p>
                                
                                <!-- Copy Feedback Message -->
                                <div id="copyFeedback" 
                                     style="display: none; margin-top: 10px; padding: 10px; background: rgba(76, 175, 80, 0.2); border: 1px solid #4CAF50; border-radius: 5px; color: #4CAF50; text-align: center; font-weight: bold;">
                                    <i class="fas fa-check-circle"></i> ID copied to clipboard!
                                </div>
                            </div>

                            <div class="setting-group">
                                <label><i class="fas fa-user-plus"></i> Add Friend by User ID:</label>
                                <div style="display: flex; gap: 10px; margin-top: 5px;">
                                    <input type="text" id="friendPublicId" placeholder="Enter friend's 6-character ID" style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; flex: 1;">
                                    <button class="auth-button" onclick="searchAndAddFriend()" style="padding: 10px 15px;">
                                        <i class="fas fa-search"></i> Search
                                    </button>
                                </div>
                                <p style="margin-top: 5px; font-size: 0.85em; color: #666;">Enter a 6-character public ID to find and add a friend</p>
                                
                                <!-- Search Results Container -->
                                <div id="friendSearchResults" style="margin-top: 10px; display: none;">
                                    <div style="background: rgba(0, 0, 0, 0.2); padding: 10px; border-radius: 5px; border: 1px solid #444;">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div style="font-weight: bold; color: #fff;" id="searchResultUsername">-</div>
                                                <div style="font-size: 0.85em; color: #aaa;">ID: <span id="searchResultId">-</span></div>
                                            </div>
                                            <button class="auth-button" onclick="confirmAddFriend()" style="padding: 8px 15px; font-size: 0.9em;">
                                                <i class="fas fa-user-plus"></i> Add Friend
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="setting-group">
                                <label><i class="fas fa-phone"></i> Register Phone Number:</label>
                                <div style="display: flex; gap: 10px; margin-top: 5px;">
                                    <button class="auth-button" onclick="registerPhoneNumber()" style="padding: 10px 15px; flex: 1;">
                                        <i class="fas fa-edit"></i> Register Phone
                                    </button>
                                </div>
                                <p style="margin-top: 5px; font-size: 0.85em; color: #666;">Register your phone number so others can find you</p>
                            </div>

                            <div class="setting-group">
                                <label><i class="fas fa-user-friends"></i> Add Test Friends:</label>
                                <div style="display: flex; gap: 10px; margin-top: 5px;">
                                    <button class="auth-button" onclick="addTestFriends()" style="padding: 10px 15px; flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);">
                                        <i class="fas fa-plus"></i> Add Test Friends
                                    </button>
                                </div>
                                <p style="margin-top: 5px; font-size: 0.85em; color: #666;">Add sample friends for testing purposes</p>
                            </div>

                            <div class="setting-group">
                                <label><i class="fas fa-save"></i> Conversation Management:</label>
                                <div style="display: flex; gap: 10px; margin-top: 5px;">
                                    <button class="auth-button" onclick="saveConversation()" style="padding: 10px 15px; flex: 1;">
                                        <i class="fas fa-save"></i> Save Conversation
                                    </button>
                                    <button class="auth-button secondary" onclick="loadConversation()" style="padding: 10px 15px; flex: 1;">
                                        <i class="fas fa-folder-open"></i> Load Conversation
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="setting-actions">
                            <button class="auth-button" onclick="applyCustomizations()">
                                <i class="fas fa-check"></i> Apply Customizations
                            </button>
                            <button class="auth-button secondary" onclick="toggleAppearanceSettings()">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>

                    <div class="friend-requests-section" id="friendRequestsSection">
                        <h3><i class="fas fa-user-friends"></i> Friend Requests</h3>
                        <div id="friendRequestsContainer"></div>
                    </div>

                    <div id="chatContainer" class="chat-container"></div>

                    <!-- Input Area - Fixed at Bottom -->
                    <div class="input-area">
                        <div class="typing-indicator" id="typingIndicator" style="display: none; padding: 5px 15px; color: #6c757d; font-size: 0.9em;">
                            <i class="fas fa-pen"></i> <span id="typingText"></span> is typing...
                        </div>
                        <div style="display: flex; width: 100%; gap: 8px; align-items: center; padding: 10px 15px;">
                            <div style="position: relative;">
                                <button class="action-button" title="Attach File" onclick="document.getElementById('fileInput').click()" style="width: 40px; height: 40px;">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                            <input type="text" id="messageInput" placeholder="Type a message..." onkeypress="handleKeyPress(event)" onkeyup="handleTypingStatus()" style="flex: 1; padding: 12px 15px; border: 1px solid #444; border-radius: 25px; font-size: 0.95rem; background: #222; color: var(--white); transition: var(--transition); box-shadow: inset 0 0 5px rgba(0,0,0,0.5);">
                            <div style="position: relative;">
                                <button class="action-button" title="Emoji" onclick="toggleEmojiPanel()" style="width: 40px; height: 40px;">
                                    <i class="far fa-smile"></i>
                                </button>
                            </div>
                            <div style="position: relative;">
                                <button class="action-button" title="Voice Recording" id="voiceRecordButton" onclick="toggleVoiceRecording()" style="width: 40px; height: 40px;">
                                    <i class="fas fa-microphone"></i>
                                </button>
                                <div style="position: relative;">
                                    <button class="action-button" title="More Options" id="moreOptionsButton" onclick="toggleMoreOptionsMenu()" style="width: 40px; height: 40px;">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <div id="moreOptionsMenu" style="display: none; position: absolute; bottom: 45px; right: 0; background: #1a1a1a; border-radius: 8px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.5); z-index: 1000; width: 200px;">
                                        <div style="padding: 5px 0; font-size: 0.8em; color: #aaa; text-align: center;">More Options</div>
                                        <div class="more-option" onclick="toggleVoiceEffectMenu()" style="padding: 8px; cursor: pointer; border-radius: 5px; margin: 2px 0; transition: background 0.2s; display: flex; align-items: center;">
                                            <i class="fas fa-sliders-h" style="margin-right: 8px;"></i> Voice Effects
                                        </div>
                                        <div class="more-option" onclick="toggleNovaMenu()" style="padding: 8px; cursor: pointer; border-radius: 5px; margin: 2px 0; transition: background 0.2s; display: flex; align-items: center;">
                                            <i class="fas fa-robot" style="margin-right: 8px;"></i> Nova AI
                                        </div>
                                        <div class="more-option" onclick="startVideoCall()" style="padding: 8px; cursor: pointer; border-radius: 5px; margin: 2px 0; transition: background 0.2s; display: flex; align-items: center;">
                                            <i class="fas fa-video" style="margin-right: 8px;"></i> Video Call
                                        </div>
                                        <div class="more-option" onclick="toggleTranslatePanel()" style="padding: 8px; cursor: pointer; border-radius: 5px; margin: 2px 0; transition: background 0.2s; display: flex; align-items: center;">
                                            <i class="fas fa-language" style="margin-right: 8px;"></i> Translate
                                        </div>
                                        <div class="more-option" onclick="securityScanner.toggleScanning()" style="padding: 8px; cursor: pointer; border-radius: 5px; margin: 2px 0; transition: background 0.2s; display: flex; align-items: center;">
                                            <i class="fas fa-shield-alt" style="margin-right: 8px;"></i> Security Scan
                                        </div>
                                    </div>
                                </div>
                                <div style="position: relative;">
                                    <div id="securityStatusIndicator" style="position: absolute; top: -5px; right: -5px; width: 12px; height: 12px; border-radius: 50%; background-color: #0be881; border: 1px solid #000;" title="Security Scanner Active"></div>
                                    <div id="cameraStatusIndicator" style="position: absolute; top: -5px; right: 15px; width: 12px; height: 12px; border-radius: 50%; background-color: #ff4757; border: 1px solid #000;" title="Camera Status"></div>
                                </div>
                            </div>
                            <button class="send-button" id="sendButton" onclick="sendMessage()" style="width: 40px; height: 40px; border-radius: 50%; background: var(--gradient-primary); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 10px rgba(106, 17, 203, 0.5);">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>

                        <!-- Voice Recording Indicator -->
                        <div id="voiceRecordingIndicator" style="display: none; position: absolute; bottom: 80px; right: 20px; background: #8b0000; color: white; padding: 10px 15px; border-radius: 20px; box-shadow: 0 0 15px rgba(255, 0, 0, 0.5);">
                            <i class="fas fa-microphone" style="margin-right: 8px;"></i> Recording...
                            <span id="recordingTime">00:00</span>
                        </div>

                        <!-- File Preview Container -->
                        <div id="filePreviewContainer" style="display: none; padding: 0 15px 10px; width: 100%;">
                            <div style="display: flex; align-items: center; gap: 10px; background: rgba(34, 34, 34, 0.8); padding: 8px 12px; border-radius: 8px; border: 1px solid #444;">
                                <div id="filePreview" style="display: flex; align-items: center; gap: 8px; flex: 1; overflow: hidden;">
                                    <!-- Preview content will be inserted here -->
                                </div>
                                <button onclick="removeSelectedFile()" style="background: #8b0000; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px;"></button>
                            </div>
                        </div>
                    </div> <!-- Close input-area div -->
                </div> <!-- Close chat-area div -->

                <!-- Move menus outside of chat area to prevent layout issues -->
                <!-- Voice Effect Menu -->
                <div id="voiceEffectMenu" style="display: none; position: absolute; bottom: 80px; right: 20px; background: #1a1a1a; border-radius: 10px; padding: 15px; box-shadow: 0 4px 20px rgba(139, 0, 0, 0.5); z-index: 1000; width: 200px; border: 1px solid #444;">
                    <div style="padding: 5px 0; font-size: 0.8em; color: #aaa; text-align: center;">Voice Effects</div>
                    <div class="voice-effect-option" onclick="setVoiceEffect('normal')" style="padding: 8px; cursor: pointer; border-radius: 5px; margin: 2px 0; transition: background 0.2s; display: flex; align-items: center;">
                        <i class="fas fa-microphone" style="margin-right: 8px;"></i> Normal
                    </div>
                    <div class="voice-effect-option" onclick="setVoiceEffect('robotic')" style="padding: 8px; cursor: pointer; border-radius: 5px; margin: 2px 0; transition: background 0.2s; display: flex; align-items: center;">
                        <i class="fas fa-robot" style="margin-right: 8px;"></i> Robotic
                    </div>
                    <div class="voice-effect-option" onclick="setVoiceEffect('chipmunk')" style="padding: 8px; cursor: pointer; border-radius: 5px; margin: 2px 0; transition: background 0.2s; display: flex; align-items: center;">
                        <i class="fas fa-bullhorn" style="margin-right: 8px;"></i> Chipmunk
                    </div>
                    <div class="voice-effect-option" onclick="setVoiceEffect('demon')" style="padding: 8px; cursor: pointer; border-radius: 5px; margin: 2px 0; transition: background 0.2s; display: flex; align-items: center;">
                        <i class="fas fa-ghost" style="margin-right: 8px;"></i> Demon
                    </div>
                    <div class="voice-effect-option" onclick="setVoiceEffect('whisper')" style="padding: 8px; cursor: pointer; border-radius: 5px; margin: 2px 0; transition: background 0.2s; display: flex; align-items: center;">
                        <i class="fas fa-volume-mute" style="margin-right: 8px;"></i> Whisper
                    </div>
                    <div class="voice-effect-option" onclick="setVoiceEffect('alien')" style="padding: 8px; cursor: pointer; border-radius: 5px; margin: 2px 0; transition: background 0.2s; display: flex; align-items: center;">
                        <i class="fas fa-user-astronaut" style="margin-right: 8px;"></i> Alien
                    </div>
                </div>

                <!-- Nova AI Menu -->
                <div id="novaMenu" style="display: none; position: absolute; bottom: 80px; right: 20px; background: #1a1a1a; border-radius: 10px; padding: 15px; box-shadow: 0 4px 20px rgba(139, 0, 0, 0.5); z-index: 1000; width: 220px; border: 1px solid #444;">
                    <div style="padding: 5px 0; font-size: 0.8em; color: #aaa; text-align: center;">Nova AI Assistant</div>
                    <div style="padding: 8px; border-bottom: 1px solid #444; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between;">
                        <span>AI Monitoring</span>
                        <span id="novaMonitoringStatus" style="color: #ff4757;">OFF</span>
                    </div>
                    <div class="nova-option" onclick="toggleNovaMonitoring()" style="padding: 8px; cursor: pointer; border-radius: 5px; margin: 2px 0; transition: background 0.2s; display: flex; align-items: center;">
                        <i class="fas fa-power-off" style="margin-right: 8px;"></i> Toggle Monitoring
                    </div>
                    <div class="nova-submenu" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #444;">
                        <div style="font-size: 0.8em; color: #aaa; margin-bottom: 5px;">Participation Mode</div>
                        <div class="nova-option" onclick="setNovaParticipation('passive')" style="padding: 6px 8px; cursor: pointer; border-radius: 5px; margin: 2px 0; transition: background 0.2s; font-size: 0.9em;">
                            Passive
                        </div>
                        <div class="nova-option" onclick="setNovaParticipation('active')" style="padding: 6px 8px; cursor: pointer; border-radius: 5px; margin: 2px 0; transition: background 0.2s; font-size: 0.9em;">
                            Active
                        </div>
                        <div class="nova-option" onclick="setNovaParticipation('automatic')" style="padding: 6px 8px; cursor: pointer; border-radius: 5px; margin: 2px 0; transition: background 0.2s; font-size: 0.9em;">
                            Automatic
                        </div>
                    </div>
                    <div class="nova-submenu" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #444;">
                        <div style="font-size: 0.8em; color: #aaa; margin-bottom: 5px;">Personality</div>
                        <div class="nova-option" onclick="setNovaPersonality('friendly')" style="padding: 6px 8px; cursor: pointer; border-radius: 5px; margin: 2px 0; transition: background 0.2s; font-size: 0.9em;">
                            Friendly
                        </div>
                        <div class="nova-option" onclick="setNovaPersonality('professional')" style="padding: 6px 8px; cursor: pointer; border-radius: 5px; margin: 2px 0; transition: background 0.2s; font-size: 0.9em;">
                            Professional
                        </div>
                        <div class="nova-option" onclick="setNovaPersonality('humorous')" style="padding: 6px 8px; cursor: pointer; border-radius: 5px; margin: 2px 0; transition: background 0.2s; font-size: 0.9em;">
                            Humorous
                        </div>
                    </div>
                </div>

                        <!-- Video Call Interface -->
                        <div id="videoCallInterface" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; flex-direction: column; justify-content: center; align-items: center; color: white;">
                            <div style="position: relative; width: 80%; max-width: 800px; text-align: center;">
                                <h2>Video Call with <span id="callPartnerName">Friend</span></h2>

                                <div style="display: flex; justify-content: space-around; margin: 20px 0;">
                                    <div style="position: relative; width: 40%; height: 300px; background: black; border: 2px solid #4a6fa5; border-radius: 10px; overflow: hidden;">
                                        <video id="localVideo" autoplay muted style="width: 100%; height: 100%; object-fit: cover;"></video>
                                        <div id="localAvatar" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 50px;"></div>
                                    </div>

                                    <div style="position: relative; width: 40%; height: 300px; background: black; border: 2px solid #4a6fa5; border-radius: 10px; overflow: hidden;">
                                        <video id="remoteVideo" autoplay style="width: 100%; height: 100%; object-fit: cover;"></video>
                                        <div id="remoteAvatar" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #333; display: flex; align-items: center; justify-content: center; font-size: 50px;"></div>
                                    </div>
                                </div>

                                <div style="margin-top: 20px;">
                                    <button class="auth-button" onclick="toggleVideo()" style="margin: 0 5px; padding: 10px 20px;">
                                        <i class="fas fa-eye"></i> <span id="videoToggleText">Hide Video</span>
                                    </button>
                                    <button class="auth-button" onclick="endVideoCall()" style="background: linear-gradient(135deg, #ff4757 0%, #cc0000 100%); margin: 0 5px; padding: 10px 20px;">
                                        <i class="fas fa-phone-slash"></i> End Call
                                    </button>
                                    <button class="auth-button" onclick="toggleFaceMask()" style="margin: 0 5px; padding: 10px 20px;">
                                        <i class="fas fa-mask"></i> <span id="maskToggleText">Show Real Face</span>
                                    </button>
                                    <button class="auth-button" onclick="showAvatarSelection()" style="margin: 0 5px; padding: 10px 20px;">
                                        <i class="fas fa-user-circle"></i> Change Avatar
                                    </button>
                                </div>

                                <!-- Avatar Selection Panel -->
                                <div id="avatarSelectionPanel" style="display: none; position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); background: #1a1a1a; border-radius: 10px; padding: 15px; box-shadow: 0 4px 20px rgba(139, 0, 0, 0.5); z-index: 1001; width: 300px; border: 1px solid #444;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                        <h4 style="color: white; margin: 0;">Select Avatar</h4>
                                        <button onclick="hideAvatarSelection()" style="background: #8b0000; color: white; border: none; border-radius: 5px; padding: 5px 10px; cursor: pointer;">Close</button>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                                        <span class="avatar-option" onclick="selectAvatar('')" style="font-size: 24px; cursor: pointer; text-align: center; padding: 5px; border-radius: 5px; transition: transform 0.2s;"></span>
                                        <span class="avatar-option" onclick="selectAvatar('')" style="font-size: 24px; cursor: pointer; text-align: center; padding: 5px; border-radius: 5px; transition: transform 0.2s;"></span>
                                        <span class="avatar-option" onclick="selectAvatar('')" style="font-size: 24px; cursor: pointer; text-align: center; padding: 5px; border-radius: 5px; transition: transform 0.2s;"></span>
                                        <span class="avatar-option" onclick="selectAvatar('')" style="font-size: 24px; cursor: pointer; text-align: center; padding: 5px; border-radius: 5px; transition: transform 0.2s;"></span>
                                        <span class="avatar-option" onclick="selectAvatar('')" style="font-size: 24px; cursor: pointer; text-align: center; padding: 5px; border-radius: 5px; transition: transform 0.2s;"></span>
                                        <span class="avatar-option" onclick="selectAvatar('')" style="font-size: 24px; cursor: pointer; text-align: center; padding: 5px; border-radius: 5px; transition: transform 0.2s;"></span>
                                        <span class="avatar-option" onclick="selectAvatar('')" style="font-size: 24px; cursor: pointer; text-align: center; padding: 5px; border-radius: 5px; transition: transform 0.2s;"></span>
                                        <span class="avatar-option" onclick="selectAvatar('')" style="font-size: 24px; cursor: pointer; text-align: center; padding: 5px; border-radius: 5px; transition: transform 0.2s;"></span>
                                        <span class="avatar-option" onclick="selectAvatar('')" style="font-size: 24px; cursor: pointer; text-align: center; padding: 5px; border-radius: 5px; transition: transform 0.2s;"></span>
                                        <span class="avatar-option" onclick="selectAvatar('')" style="font-size: 24px; cursor: pointer; text-align: center; padding: 5px; border-radius: 5px; transition: transform 0.2s;"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hidden file input -->
                    <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload(event)">

                    <!-- Emoji Picker Panel -->
                    <div class="emoji-panel" id="emojiPanel" style="display: none; position: absolute; bottom: 80px; right: 20px; background: #1a1a1a; border-radius: 10px; padding: 15px; box-shadow: 0 4px 20px rgba(139, 0, 0, 0.5); z-index: 1000; width: 300px; border: 1px solid #444;">
                        <div style="display: grid; grid-template-columns: repeat(8, 1fr); gap: 5px;">
                            <span class="emoji-option" style="--i: 0;" onclick="insertEmoji('')"></span>
                            <span class="emoji-option" style="--i: 1;" onclick="insertEmoji('')"></span>
                            <span class="emoji-option" style="--i: 2;" onclick="insertEmoji('')"></span>
                            <span class="emoji-option" style="--i: 3;" onclick="insertEmoji('')"></span>
                            <span class="emoji-option" style="--i: 4;" onclick="insertEmoji('')"></span>
                            <span class="emoji-option" style="--i: 5;" onclick="insertEmoji('')"></span>
                            <span class="emoji-option" style="--i: 6;" onclick="insertEmoji('')"></span>
                            <span class="emoji-option" style="--i: 7;" onclick="insertEmoji('')"></span>
                            <span class="emoji-option" style="--i: 8;" onclick="insertEmoji('')"></span>
                            <span class="emoji-option" style="--i: 9;" onclick="insertEmoji('')"></span>
                            <span class="emoji-option" style="--i: 10;" onclick="insertEmoji('')"></span>
                            <span class="emoji-option" style="--i: 11;" onclick="insertEmoji('')"></span>
                            <span class="emoji-option" style="--i: 12;" onclick="insertEmoji('')"></span>
                            <span class="emoji-option" style="--i: 13;" onclick="insertEmoji('')"></span>
                            <span class="emoji-option" style="--i: 14;" onclick="insertEmoji('')"></span>
                            <span class="emoji-option" style="--i: 15;" onclick="insertEmoji('')"></span>
                        </div>
                    </div>

                    <!-- Translate Panel -->
                    <div class="translate-panel" id="translatePanel" style="display: none; position: absolute; bottom: 80px; right: 20px; background: #1a1a1a; border-radius: 10px; padding: 15px; box-shadow: 0 4px 20px rgba(139, 0, 0, 0.5); z-index: 1000; width: 300px; border: 1px solid #444;">
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <input type="text" id="translateInput" placeholder="Enter text to translate..." style="padding: 8px; border: 1px solid #444; border-radius: 5px; background: #222; color: #e0e0e0;">
                            <div style="display: flex; gap: 5px;">
                                <select id="sourceLang" style="flex: 1; padding: 8px; border: 1px solid #444; border-radius: 5px; background: #222; color: #e0e0e0;">
                                    <option value="auto">Auto Detect</option>
                                    <option value="en">English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="it">Italian</option>
                                    <option value="pt">Portuguese</option>
                                    <option value="ru">Russian</option>
                                    <option value="ja">Japanese</option>
                                    <option value="ko">Korean</option>
                                    <option value="zh">Chinese</option>
                                    <option value="ar">Arabic</option>
                                </select>
                                <select id="targetLang" style="flex: 1; padding: 8px; border: 1px solid #444; border-radius: 5px; background: #222; color: #e0e0e0;">
                                    <option value="en">English</option>
                                    <option value="es">Spanish</option>
                                    <option value="fr">French</option>
                                    <option value="de">German</option>
                                    <option value="it">Italian</option>
                                    <option value="pt">Portuguese</option>
                                    <option value="ru">Russian</option>
                                    <option value="ja">Japanese</option>
                                    <option value="ko">Korean</option>
                                    <option value="zh">Chinese</option>
                                    <option value="ar">Arabic</option>
                                </select>
                            </div>
                            <button class="auth-button" onclick="performTranslation()" style="padding: 8px; border-radius: 5px;">Translate</button>
                            <textarea id="translateOutput" placeholder="Translation will appear here..." readonly style="height: 80px; padding: 8px; border: 1px solid #444; border-radius: 5px; background: #222; color: #e0e0e0;"></textarea>
                        </div>
                    </div>

                </div>
            </div>
        </div>

        <!-- Collapsible Friends Menu Button -->
        <button id="friendsMenuToggle" class="friends-menu-toggle" title="Open Friends List">
            <i class="fas fa-users"></i>
        </button>

        <!-- Collapsible Friends Menu -->
        <div id="friendsMenu" class="friends-menu">
            <!-- Profile Card - Always Visible at Top -->
            <div class="profile-card" id="profileCard">
                <div class="profile-avatar" id="profileAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="profile-info">
                    <div class="profile-label">Your ID</div>
                    <div class="profile-id-display" id="profileIdDisplay">Loading...</div>
                    <button class="copy-id-btn" onclick="copyProfileId()" title="Copy ID to clipboard">
                        <i class="fas fa-copy"></i> <span>Copy</span>
                    </button>
                    <div class="copy-feedback" id="copyFeedback">
                        <i class="fas fa-check-circle"></i> Copied!
                    </div>
                </div>
            </div>
            
            <div class="friends-menu-header">
                <h3><i class="fas fa-users"></i> Contacts</h3>
                <div style="display: flex; gap: 8px;">
                    <button id="quickJoinBtn" class="quick-join-btn" title="Quick Join" onclick="quickJoinAction()">
                        <i class="fas fa-qrcode"></i>
                    </button>
                    <button id="closeFriendsMenu" class="close-friends-menu" title="Close Menu">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="friends-menu-tabs">
                <div class="friends-menu-tab active" data-tab="friends">Friends</div>
                <div class="friends-menu-tab" data-tab="all">All Contacts</div>
            </div>
            <div id="friendsMenuContainer" class="friends-menu-list"></div>
        </div>
    </div>

    <script>
        // Fallback for novaChatMonitor if the script is not loaded
        // DISABLED: Nova AI monitoring and auto-responses turned off
        const novaChatMonitor = {
            isEnabled: false,
            processMessage: function() {},
            enableMonitoring: function() { console.log(' [Nova AI] Monitoring is disabled'); },
            disableMonitoring: function() { console.log(' [Nova AI] Monitoring disabled'); },
            setParticipationMode: function() { console.log(' [Nova AI] Participation mode is disabled'); },
            setPersonality: function() { console.log(' [Nova AI] Personality settings are disabled'); }
        };

        // Firebase configuration
    const firebaseConfig = {
  apiKey: "AIzaSyDfc7OVUdNQUBq18bLKhRFS9jy6DbXiu_I", //     
  authDomain: "mychatapp-4b53d.firebaseapp.com",
  projectId: "mychatapp-4b53d",
  storageBucket: "mychatapp-4b53d.firebasestorage.app",
  messagingSenderId: "428752077292",
  appId: "1:428752077292:web:1662545d7687c4135100c9"
};
        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Global state
        let currentUser = null;
        let currentUsername = null;
        let currentUserId = null;
        let currentUserPublicId = null; // Short, simple ID for user identification
        let contacts = [];
        let friends = [];
        let friendRequests = [];
        let selectedContact = null;
        let selectedChat = null;
        let currentTab = 'friends'; // Default tab

        // Translator for obfuscation (using the same as in translation.html)
        const translator = {
            // Create the same mapping as in other modules
            initializeMaps: function() {
                const encodingMap = {};
                const decodingMap = {};
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
                const substitutes = 'ZYXWVUTSRQPONMLKJIHGFEDCBAzyxwvutsrqponmlkjihgfedcba9876543210';

                for (let i = 0; i < chars.length; i++) {
                    encodingMap[chars[i]] = substitutes[i];
                    decodingMap[substitutes[i]] = chars[i];
                }

                return { encodingMap, decodingMap };
            },

            // UTF-8 safe string to array conversion for proper Unicode support
            stringToUTF8Array: function(str) {
                const utf8 = unescape(encodeURIComponent(str));
                const arr = [];
                for (let i = 0; i < utf8.length; i++) {
                    arr.push(utf8.charCodeAt(i));
                }
                return arr;
            },

            // UTF-8 safe array to string conversion for proper Unicode support
            utf8ArrayToString: function(arr) {
                const utf8 = String.fromCharCode.apply(null, arr);
                return decodeURIComponent(escape(utf8));
            },

            // Enhanced encoding with additional obfuscation - UTF-8 safe for emojis and Arabic
            advancedEncode: function(text) {
                if (!text) return '';

                try {
                    // Apply multiple layers of obfuscation
                    let result = text;

                    // Layer 1: Reverse the string (properly handle Unicode surrogate pairs)
                    result = Array.from(result).reverse().join('');

                    // Layer 2: UTF-8 safe Base64 encode
                    // Convert to UTF-8 bytes first, then encode each byte
                    const utf8Bytes = this.stringToUTF8Array(result);
                    let binaryString = '';
                    for (let i = 0; i < utf8Bytes.length; i++) {
                        binaryString += String.fromCharCode(utf8Bytes[i]);
                    }
                    result = btoa(binaryString);

                    // Layer 3: Character substitution
                    const maps = this.initializeMaps();
                    let substituted = '';
                    for (let i = 0; i < result.length; i++) {
                        const char = result[i];
                        substituted += maps.encodingMap[char] || char; // Keep unmapped characters as is
                    }

                    return substituted;
                } catch (error) {
                    console.error('Encoding error:', error);
                    // Fallback: return original text if encoding fails
                    return text;
                }
            },

            // Enhanced decoding to reverse the advanced encoding - UTF-8 safe for emojis and Arabic
            advancedDecode: function(encodedText) {
                if (!encodedText) return '';

                try {
                    // Reverse layer 3: Character substitution
                    const maps = this.initializeMaps();
                    let base64Text = '';
                    for (let i = 0; i < encodedText.length; i++) {
                        const char = encodedText[i];
                        base64Text += maps.decodingMap[char] || char; // Keep unmapped characters as is
                    }

                    // Reverse layer 2: UTF-8 safe Base64 decode
                    const binaryString = atob(base64Text);
                    const utf8Bytes = [];
                    for (let i = 0; i < binaryString.length; i++) {
                        utf8Bytes.push(binaryString.charCodeAt(i));
                    }
                    
                    // Reverse layer 1: Reverse the string back (properly handle Unicode surrogate pairs)
                    const reversedText = this.utf8ArrayToString(utf8Bytes);
                    const originalText = Array.from(reversedText).reverse().join('');

                    return originalText;
                } catch (error) {
                    console.error('Decoding error:', error);
                    // Fallback: return original encoded text if decoding fails
                    return encodedText;
                }
            }
        };

        // Voice changing system
        const voiceChanger = {
            currentVoice: 'normal', // Default voice setting
            voiceEffects: {
                'normal': { pitch: 1.0, speed: 1.0, distortion: 0 },
                'robotic': { pitch: 1.0, speed: 1.0, distortion: 0.5 },
                'chipmunk': { pitch: 1.8, speed: 1.2, distortion: 0 },
                'demon': { pitch: 0.7, speed: 0.9, distortion: 0.3 },
                'whisper': { pitch: 1.0, speed: 1.0, distortion: 0.2 },
                'alien': { pitch: 1.2, speed: 0.8, distortion: 0.4 }
            },

            // Apply voice effect to audio buffer
            applyEffect: function(audioBuffer, effect) {
                // Create offline audio context for processing
                const offlineContext = new OfflineAudioContext(
                    audioBuffer.numberOfChannels,
                    audioBuffer.length,
                    audioBuffer.sampleRate
                );

                const source = offlineContext.createBufferSource();
                source.buffer = audioBuffer;

                // Create audio nodes for effects
                const gainNode = offlineContext.createGain();
                gainNode.gain.value = 1.0;

                // Pitch shifting is complex and requires specialized libraries
                // For simplicity in this implementation, we'll just return the original buffer
                // In a real implementation, you'd use a library like Tone.js or Web Audio API advanced features

                source.connect(gainNode);
                gainNode.connect(offlineContext.destination);

                source.start();

                return offlineContext.startRendering().then(processedBuffer => {
                    return processedBuffer;
                });
            },

            // Set current voice effect
            setVoice: function(voiceType) {
                if (this.voiceEffects[voiceType]) {
                    this.currentVoice = voiceType;
                    addSystemMessage(`Voice changed to ${voiceType}`);
                } else {
                    console.warn(`Voice type ${voiceType} not found`);
                }
            }
        };

        // Voice recording functionality
        let mediaRecorder;
        let audioChunks = [];
        let recordingStartTime;
        let recordingInterval;

        async function toggleVoiceRecording() {
            const recordButton = document.getElementById('voiceRecordButton');
            const indicator = document.getElementById('voiceRecordingIndicator');

            if (!mediaRecorder || mediaRecorder.state === 'inactive') {
                // Request microphone permission and start recording
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        // Create blob from recorded audio
                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(audioBlob);

                        // Apply voice effect if not normal
                        if (voiceChanger.currentVoice !== 'normal') {
                            // In a real implementation, we would process the audio with the selected effect
                            // For now, we'll just add a note about the voice effect used
                            addVoiceMessageWithEffect(currentUsername, audioUrl, voiceChanger.currentVoice, true);
                        } else {
                            // Send the voice message normally
                            sendVoiceMessage(audioUrl, audioBlob);
                        }

                        // Stop all tracks to release microphone
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    recordingStartTime = new Date();

                    // Update UI to show recording state
                    recordButton.innerHTML = '<i class="fas fa-stop"></i>';
                    recordButton.style.background = 'linear-gradient(135deg, #ff4757 0%, #cc0000 100%)';
                    indicator.style.display = 'block';

                    // Start recording timer
                    recordingInterval = setInterval(updateRecordingTimer, 1000);

                    addSystemMessage('Voice recording started...');
                } catch (error) {
                    console.error('Error accessing microphone:', error);
                    alert('Microphone access denied. Please enable microphone permissions to record voice messages.');
                }
            } else if (mediaRecorder.state === 'recording') {
                // Stop recording
                mediaRecorder.stop();

                // Stop timer
                clearInterval(recordingInterval);

                // Reset UI
                recordButton.innerHTML = '<i class="fas fa-microphone"></i>';
                recordButton.style.background = 'linear-gradient(135deg, #8b0000 0%, #4b0000 100%)';
                indicator.style.display = 'none';
                document.getElementById('recordingTime').textContent = '00:00';
            }
        }

        // Add voice message with effect indication
        function addVoiceMessageWithEffect(username, audioUrl, voiceEffect, isSent, isReceivedFromOther = false) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');

            // Determine the correct class based on whether it's sent or received
            if (isReceivedFromOther) {
                messageDiv.className = 'message received';
            } else {
                messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            }

            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const dateString = now.toLocaleDateString();

            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="username">${username}</span>
                    <div class="message-meta">
                        <span class="timestamp">${timeString}</span>
                        <span class="datestamp">${dateString}</span>
                        ${isSent ? '<span class="message-status" title="Delivered"><i class="fas fa-check-double"></i></span>' : ''}
                    </div>
                </div>
                <div class="message-content">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-microphone" style="color: var(--primary-color);"></i>
                        <div>
                            <div>Voice Message (${voiceEffect} voice)</div>
                            <audio controls style="width: 100%;">
                                <source src="${audioUrl}" type="audio/webm">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                    </div>
                </div>
                <div class="message-reactions">
                    <span class="reaction" onclick="addReaction(this, '')"></span>
                    <span class="reaction" onclick="addReaction(this, '')"></span>
                    <span class="reaction" onclick="addReaction(this, '')"></span>
                    <span class="reaction" onclick="addReaction(this, '')"></span>
                    <span class="reaction" onclick="addReaction(this, '')"></span>
                </div>
            `;

            // Add the message to the container
            chatContainer.appendChild(messageDiv);

            // Force a reflow to ensure the element is rendered
            messageDiv.offsetHeight;

            // Always scroll to the bottom to behave like messenger
            // Use smooth scrolling for better UX
            chatContainer.scrollTo({
                top: chatContainer.scrollHeight,
                behavior: 'smooth'
            });

            //  Nova AI is DISABLED - No AI observation of incoming messages
        }

        function updateRecordingTimer() {
            const currentTime = new Date();
            const elapsedTime = new Date(currentTime - recordingStartTime);

            const minutes = String(elapsedTime.getMinutes()).padStart(2, '0');
            const seconds = String(elapsedTime.getSeconds()).padStart(2, '0');

            document.getElementById('recordingTime').textContent = `${minutes}:${seconds}`;
        }

        function sendVoiceMessage(audioUrl, audioBlob) {
            if (!selectedContact) {
                alert('Please select a contact to send a voice message to');
                return;
            }

            // Check if selected contact is a friend
            const isFriend = friends.some(f => f.id === selectedContact.id);
            if (!isFriend) {
                alert('You can only send messages to friends. Send a friend request first.');
                return;
            }

            // Create a unique filename for the voice message
            const fileName = `voice_message_${Date.now()}.webm`;

            // Add voice message to chat
            addVoiceMessage(currentUsername, fileName, audioUrl, true);

            // In a real implementation, this would send via server.sendMessage()
            // For simulation, we'll just display locally and trigger a response
            // Encode the audio as base64 for transmission
            const reader = new FileReader();
            reader.onload = function() {
                const encodedAudio = reader.result; // This is a data URL
                server.sendMessage(selectedContact.id, encodedAudio, false); // Don't encrypt voice data
            };
            reader.readAsDataURL(audioBlob);
        }

        function addVoiceMessage(username, fileName, audioUrl, isSent, isReceivedFromOther = false) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');

            // Determine the correct class based on whether it's sent or received
            if (isReceivedFromOther) {
                messageDiv.className = 'message received';
            } else {
                messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            }

            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const dateString = now.toLocaleDateString();

            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="username">${username}</span>
                    <div class="message-meta">
                        <span class="timestamp">${timeString}</span>
                        <span class="datestamp">${dateString}</span>
                        ${isSent ? '<span class="message-status" title="Delivered"><i class="fas fa-check-double"></i></span>' : ''}
                    </div>
                </div>
                <div class="message-content">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-microphone" style="color: var(--primary-color);"></i>
                        <div>
                            <div>Voice Message</div>
                            <audio controls style="width: 100%;">
                                <source src="${audioUrl}" type="audio/webm">
                                Your browser does not support the audio element.
                            </audio>
                        </div>
                    </div>
                </div>
                <div class="message-reactions">
                    <span class="reaction" onclick="addReaction(this, '')"></span>
                    <span class="reaction" onclick="addReaction(this, '')"></span>
                    <span class="reaction" onclick="addReaction(this, '')"></span>
                    <span class="reaction" onclick="addReaction(this, '')"></span>
                    <span class="reaction" onclick="addReaction(this, '')"></span>
                </div>
            `;

            // Add the message to the container
            chatContainer.appendChild(messageDiv);

            // Force a reflow to ensure the element is rendered
            messageDiv.offsetHeight;

            // Always scroll to the bottom to behave like messenger
            // Use smooth scrolling for better UX
            chatContainer.scrollTo({
                top: chatContainer.scrollHeight,
                behavior: 'smooth'
            });

            // Notify Nova AI about the incoming message
            if (novaChatMonitor.isEnabled && !isSent) {
                novaChatMonitor.processMessage(username, message, false);
            }
        }

        // Simulated server functions
        const server = {
            // Simulate connecting to global server
            connect: function() {
                // In a real implementation, this would connect to WebSocket server
                console.log("Connecting to Monster Browser global server...");

                // Simulate connection success
                setTimeout(() => {
                    document.getElementById('statusIndicator').className = 'status-indicator online';
                    document.getElementById('statusIndicator').textContent = 'CONNECTED TO GLOBAL SERVER';
                    addSystemMessage('Connected to Monster Browser global network!');

                    // Load contacts after connection
                    loadContacts();
                    loadFriends();
                    loadFriendRequests();

                    // Add test friend if not already present
                    setTimeout(() => {
                        const testFriendExists = friends.some(friend => friend.id === 'temp1');
                        if (!testFriendExists) {
                            friends.push({
                                id: 'temp1',
                                publicId: 'T3S2T1',
                                username: 'TestFriend',
                                status: 'online',
                                addedAt: new Date().toISOString(),
                                displayName: 'TestFriend'
                            });
                            renderContacts();
                        }
                    }, 1500);
                }, 1000);
            },

            // Simulate sending a message to another user
            sendMessage: function(toUserId, message, isEncrypted = true) {
                // In a real implementation, this would send via WebSocket to the server
                // which would relay to the recipient

                // Encrypt the message if needed
                const finalMessage = isEncrypted ? translator.advancedEncode(message) : message;

                // For simulation, we'll just trigger a response after a random delay
                setTimeout(() => {
                    // Simulate receiving a response from the contact
                    const responses = [
                        "Hey there! Thanks for reaching out.",
                        "That's interesting, tell me more!",
                        "I'm using Monster Browser too, great to connect!",
                        "Nice talking with you!",
                        "What's new in the Monster Browser world?",
                        "I saw your message, thanks for contacting me!"
                    ];

                    const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                    receiveMessage(toUserId, randomResponse);
                }, 1000 + Math.random() * 3000);

                return true;
            },

            // Simulate receiving a message from another user
            receiveMessage: function(fromUserId, message, isEncrypted = true) {
                // For now, we'll simulate it
                // Note: This function is not currently used in the simulation, but kept for future implementation
            },

            // Send friend request
            sendFriendRequest: function(toUserId) {
                console.log(' Creating friend request document...');
                
                // Simulate sending a friend request
                const request = {
                    id: Date.now().toString(),
                    fromUserId: currentUserId,
                    toUserId: toUserId,
                    status: 'pending',
                    timestamp: new Date().toISOString()
                };

                // Add to friend requests
                friendRequests.push(request);
                saveData();

                console.log(' Friend request saved to local storage');

                // Update UI
                renderFriendRequests();

                console.log(' UI updated with friend request');

                addSystemMessage(`Friend request sent to user ${toUserId}`);
                
                console.log(' Success: Friend added to Firestore!');
            },

            // Accept friend request
            acceptFriendRequest: function(requestId) {
                const requestIndex = friendRequests.findIndex(req => req.id === requestId);
                if (requestIndex !== -1) {
                    const request = friendRequests[requestIndex];

                    // Find the user in contacts to get their public ID
                    const contact = contacts.find(c => c.id === request.fromUserId);

                    // Add to friends list
                    const newFriend = {
                        id: request.fromUserId,
                        publicId: contact ? contact.publicId : 'N/A', // Use public ID from contacts
                        username: getUserById(request.fromUserId).username,
                        status: 'online',
                        addedAt: new Date().toISOString()
                    };

                    friends.push(newFriend);

                    // Update request status
                    friendRequests[requestIndex].status = 'accepted';

                    // Save data
                    saveData();

                    // Update UI
                    renderContacts();
                    renderFriendRequests();

                    addSystemMessage(`Friend request from ${getUserById(request.fromUserId).username} accepted!`);
                }
            },

            // Decline friend request
            declineFriendRequest: function(requestId) {
                const requestIndex = friendRequests.findIndex(req => req.id === requestId);
                if (requestIndex !== -1) {
                    friendRequests[requestIndex].status = 'declined';
                    saveData();
                    renderFriendRequests();
                    addSystemMessage('Friend request declined.');
                }
            }
        };

        // Function to receive a message (simulated)
        function receiveMessage(senderId, message) {
            const sender = contacts.find(contact => contact.id === senderId);
            const senderName = sender ? sender.username : 'Unknown User';

            // Check if the message is a data URL (like voice messages) or plain text
            if (typeof message === 'string' && message.startsWith('data:')) {
                // This is a data URL (like voice message), don't decrypt it
                // Check if it's an audio data URL
                if (message.startsWith('data:audio/')) {
                    // Handle as voice message
                    addVoiceMessage(senderName, 'voice_message_received.webm', message, false, true);
                } else {
                    // Handle other data URLs as regular messages
                    addMessage(senderName, message, false, true);
                }
            } else {
                // This is a regular text message, decrypt it
                try {
                    const decryptedMessage = translator.advancedDecode(message);
                    addMessage(senderName, decryptedMessage, false, true); // Mark as received from others
                } catch (error) {
                    console.error('Decryption error:', error);
                    // If decryption fails, display the raw message
                    addMessage(senderName, message, false, true);
                }
            }
        }

        // Load contacts from simulated server
        function loadContacts() {
            // In a real implementation, this would fetch from the server
            // For simulation, we'll create some fake contacts with public IDs
            contacts = [
                { id: 'user1', publicId: 'A1B2C3', username: 'BrowserFan', status: 'online' },
                { id: 'user2', publicId: 'D4E5F6', username: 'WebExplorer', status: 'online' },
                { id: 'user3', publicId: 'G7H8I9', username: 'NetSurfer', status: 'away' },
                { id: 'user4', publicId: 'J0K1L2', username: 'CodeMaster', status: 'online' },
                { id: 'user5', publicId: 'M3N4P5', username: 'TechGuru', status: 'busy' }
            ];

            renderContacts();
        }

        // Load friends
        function loadFriends() {
            // Load from localStorage
            const savedFriends = localStorage.getItem('friends');
            if (savedFriends) {
                friends = JSON.parse(savedFriends);
            } else {
                // If no saved friends, add the test friend by default
                friends = [
                    {
                        id: 'temp1',
                        publicId: 'T3S2T1',
                        username: 'TestFriend',
                        status: 'online',
                        addedAt: new Date().toISOString(),
                        displayName: 'TestFriend'  // Using display name as well
                    }
                ];
            }

            // Always ensure the test friend is present for testing
            const testFriendExists = friends.some(friend => friend.id === 'temp1');
            if (!testFriendExists) {
                friends.push({
                    id: 'temp1',
                    publicId: 'T3S2T1',
                    username: 'TestFriend',
                    status: 'online',
                    addedAt: new Date().toISOString(),
                    displayName: 'TestFriend'
                });
            }

            renderContacts();
        }

        // Load friend requests
        function loadFriendRequests() {
            // Load from localStorage
            const savedRequests = localStorage.getItem('friendRequests');
            if (savedRequests) {
                friendRequests = JSON.parse(savedRequests);
            }

            renderFriendRequests();
        }

        // Render contacts list based on current tab
        function renderContacts() {
            const container = document.getElementById('friendsMenuContainer');
            if (!container) return; // Exit if container doesn't exist

            container.innerHTML = '';

            // === ADD CURRENT USER PROFILE AT THE TOP ===
            const myProfileCard = document.createElement('div');
            myProfileCard.className = 'contact-item';
            myProfileCard.style.background = 'linear-gradient(135deg, rgba(139, 0, 0, 0.3), rgba(75, 0, 0, 0.4))';
            myProfileCard.style.border = '2px solid #ffd700';
            myProfileCard.style.marginBottom = '15px';
            myProfileCard.style.position = 'relative';

            const myInitial = (currentUsername || 'Me').charAt(0).toUpperCase();

            myProfileCard.innerHTML = `
                <div class="contact-avatar" style="background: linear-gradient(135deg, #ffd700, #ff8c00); color: #000;">
                    ${myInitial}
                </div>
                <div class="contact-info" style="flex: 1;">
                    <div class="contact-name" style="color: #ffd700; font-weight: bold;">
                        ${currentUsername || 'Me'} <span style="color: #4CAF50; font-size: 0.8em;">(Me)</span>
                        <i class="fas fa-crown" style="color: #ffd700; font-size: 0.7em; margin-left: 5px;" title="My Profile"></i>
                    </div>
                    <div class="contact-status">
                        <span class="status-indicator-small status-online"></span>
                        <span style="color: #4CAF50;">Online</span>
                        <span style="margin-left: 10px; color: #aaa; font-size: 0.85em;">ID: ${currentUserPublicId || 'N/A'}</span>
                    </div>
                </div>
                <button class="copy-id-btn-small" title="Copy ID" style="background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em; margin-left: 10px; display: flex; align-items: center; gap: 5px; transition: all 0.3s ease;">
                    <i class="fas fa-copy"></i>
                </button>
            `;

            // Add click handler to open chat with self
            myProfileCard.onclick = (e) => {
                // Don't open chat if copy button was clicked
                if (e.target.closest('.copy-id-btn-small')) return;
                
                // Open chat with self for testing
                openChatWithSelf();
            };

            // Add long-press functionality to copy ID
            let pressTimer;
            myProfileCard.addEventListener('mousedown', (e) => {
                if (e.target.closest('.copy-id-btn-small')) return;
                pressTimer = setTimeout(() => {
                    if (currentUserPublicId) {
                        copyProfileId();
                        addSystemMessage(`Your Public ID (${currentUserPublicId}) copied to clipboard!`);
                        navigator.vibrate?.(50); // Haptic feedback if supported
                    }
                }, 800); // 800ms long press
            });

            myProfileCard.addEventListener('mouseup', () => clearTimeout(pressTimer));
            myProfileCard.addEventListener('mouseleave', () => clearTimeout(pressTimer));
            myProfileCard.addEventListener('touchstart', (e) => {
                if (e.target.closest('.copy-id-btn-small')) return;
                pressTimer = setTimeout(() => {
                    if (currentUserPublicId) {
                        copyProfileId();
                        addSystemMessage(`Your Public ID (${currentUserPublicId}) copied to clipboard!`);
                        navigator.vibrate?.(50); // Haptic feedback if supported
                    }
                }, 800);
            }, {passive: true});

            myProfileCard.addEventListener('touchend', () => clearTimeout(pressTimer));

            // Add copy button click handler
            const copyBtn = myProfileCard.querySelector('.copy-id-btn-small');
            copyBtn.onclick = (e) => {
                e.stopPropagation();
                if (currentUserPublicId) {
                    copyProfileId();
                    addSystemMessage(`Your Public ID (${currentUserPublicId}) copied to clipboard!`);
                    
                    // Visual feedback on button
                    copyBtn.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        copyBtn.style.transform = 'scale(1)';
                    }, 150);
                }
            };

            myProfileCard.style.cursor = 'pointer';
            myProfileCard.title = 'Click to chat with yourself (for testing) | Long-press or click copy button to copy ID';

            container.appendChild(myProfileCard);
            // =========================================

            if (currentTab === 'friends') {
                // Show friends only (after my profile)
                if (friends.length === 0) {
                    const noFriendsMsg = document.createElement('div');
                    noFriendsMsg.className = 'contact-item';
                    noFriendsMsg.innerHTML = '<div class="contact-info"><div class="contact-name">No friends yet</div><div class="contact-status">Send friend requests to connect</div></div></div>';
                    container.appendChild(noFriendsMsg);
                    return;
                }

                friends.forEach(friend => {
                    const contactElement = document.createElement('div');
                    contactElement.className = 'contact-item';
                    // Use display name if available, otherwise use original username
                    const displayName = friend.displayName || friend.username;

                    // Determine status color based on online status
                    const statusClass = friend.status === 'online' ? 'status-online' : 'status-offline';
                    const statusText = friend.status === 'online' ? 'Online' : 'Offline';

                    contactElement.innerHTML = `
                        <div class="contact-avatar">${displayName.charAt(0)}</div>
                        <div class="contact-info">
                            <div class="contact-name">${displayName} ${friend.displayName ? `<i class="fas fa-star" title="Renamed from ${friend.username}" style="color: gold; font-size: 0.7em; margin-left: 5px;"></i>` : ''}</div>
                            <div class="contact-status">
                                <span class="status-indicator-small ${statusClass}"></span>
                                ${statusText}
                            </div>
                        </div>
                    `;

                    // Add right-click context menu for renaming
                    contactElement.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showRenameMenu(e, friend);
                    });

                    contactElement.onclick = () => {
                        // Deselect all contacts
                        document.querySelectorAll('.contact-item').forEach(item => {
                            item.classList.remove('selected');
                        });

                        // Select this contact
                        contactElement.classList.add('selected');

                        selectedContact = friend;
                        selectedChat = friend.id;

                        // Initialize private chat session with proper ID verification
                        console.log(' [Chat] Opening chat with friend...');
                        console.log('  - Your ID (currentUserId):', currentUserId);
                        console.log('  - Friend ID (friend.id):', friend.id);
                        console.log('  - Your Public ID:', currentUserPublicId);
                        console.log('  - Friend Public ID:', friend.publicId || 'N/A');
                        
                        const chatId = generateChatId(currentUserId, friend.id);
                        console.log('  - Generated Chat ID:', chatId);
                        
                        listenForMessages(chatId);

                        addSystemMessage(`Selected friend: ${displayName}. Send a message to start chatting.`);
                    };

                    container.appendChild(contactElement);
                });
            } else {
                // Show all contacts (friends + non-friends)
                // Show friends first
                friends.forEach(friend => {
                    const contactElement = document.createElement('div');
                    contactElement.className = 'contact-item';
                    // Use display name if available, otherwise use original username
                    const displayName = friend.displayName || friend.username;

                    // Determine status color based on online status
                    const statusClass = friend.status === 'online' ? 'status-online' : 'status-offline';
                    const statusText = friend.status === 'online' ? 'Online' : 'Offline';

                    contactElement.innerHTML = `
                        <div class="contact-avatar">${displayName.charAt(0)}</div>
                        <div class="contact-info">
                            <div class="contact-name">${displayName} ${friend.displayName ? `<i class="fas fa-star" title="Renamed from ${friend.username}" style="color: gold; font-size: 0.7em; margin-left: 5px;"></i>` : ''}</div>
                            <div class="contact-status">
                                <span class="status-indicator-small ${statusClass}"></span>
                                ${statusText}
                            </div>
                        </div>
                    `;

                    // Add right-click context menu for renaming
                    contactElement.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showRenameMenu(e, friend);
                    });

                    contactElement.onclick = () => {
                        // Deselect all contacts
                        document.querySelectorAll('.contact-item').forEach(item => {
                            item.classList.remove('selected');
                        });

                        // Select this contact
                        contactElement.classList.add('selected');

                        selectedContact = friend;
                        selectedChat = friend.id;
                        addSystemMessage(`Selected friend: ${displayName}. Send a message to start chatting.`);
                    };

                    container.appendChild(contactElement);
                });

                // Then show other contacts
                contacts.forEach(contact => {
                    // Skip if already a friend
                    if (friends.some(f => f.id === contact.id)) return;

                    const contactElement = document.createElement('div');
                    contactElement.className = 'contact-item';
                    contactElement.innerHTML = `
                        <div class="contact-avatar">${contact.username.charAt(0)}</div>
                        <div class="contact-info">
                            <div class="contact-name">${contact.username}</div>
                            <div class="contact-status">
                                <span class="status-indicator-small status-${contact.status}"></span>
                                ${contact.status.charAt(0).toUpperCase() + contact.status.slice(1)}
                            </div>
                        </div>
                    `;

                    contactElement.onclick = () => {
                        // Deselect all contacts
                        document.querySelectorAll('.contact-item').forEach(item => {
                            item.classList.remove('selected');
                        });

                        // Select this contact
                        contactElement.classList.add('selected');

                        selectedContact = contact;
                        addSystemMessage(`Selected contact: ${contact.username}. Send a friend request to start chatting.`);
                    };

                    container.appendChild(contactElement);
                });
            }
        }

        // Function to show rename menu
        function showRenameMenu(event, friend) {
            // Remove any existing rename menus
            const existingMenu = document.getElementById('rename-menu');
            if (existingMenu) {
                existingMenu.remove();
            }

            // Create rename menu
            const menu = document.createElement('div');
            menu.id = 'rename-menu';
            menu.style.position = 'absolute';
            menu.style.left = event.pageX + 'px';
            menu.style.top = event.pageY + 'px';
            menu.style.backgroundColor = '#1a1a1a';
            menu.style.border = '1px solid #444';
            menu.style.borderRadius = '8px';
            menu.style.padding = '10px';
            menu.style.zIndex = '1000';
            menu.style.boxShadow = '0 4px 12px rgba(0,0,0,0.5)';
            menu.style.minWidth = '150px';

            // Create input field and buttons
            const input = document.createElement('input');
            input.type = 'text';
            input.id = 'rename-input';
            input.value = friend.displayName || friend.username;
            input.style.width = '100%';
            input.style.marginBottom = '8px';
            input.style.padding = '5px';
            input.style.borderRadius = '4px';
            input.style.border = '1px solid #444';
            input.style.backgroundColor = '#222';
            input.style.color = '#e0e0e0';

            const renameBtn = document.createElement('button');
            renameBtn.textContent = 'Rename';
            renameBtn.style.width = '100%';
            renameBtn.style.padding = '5px';
            renameBtn.style.marginBottom = '5px';
            renameBtn.style.border = 'none';
            renameBtn.style.borderRadius = '4px';
            renameBtn.style.cursor = 'pointer';
            renameBtn.style.backgroundColor = '#8b0000';
            renameBtn.style.color = 'white';
            renameBtn.onclick = () => {
                renameFriend(friend, document.getElementById('rename-input').value);
                menu.remove();
            };

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Cancel';
            cancelBtn.style.width = '100%';
            cancelBtn.style.padding = '5px';
            cancelBtn.style.border = 'none';
            cancelBtn.style.borderRadius = '4px';
            cancelBtn.style.cursor = 'pointer';
            cancelBtn.style.backgroundColor = '#6c757d';
            cancelBtn.style.color = 'white';
            cancelBtn.onclick = () => {
                menu.remove();
            };

            menu.appendChild(input);
            menu.appendChild(renameBtn);
            menu.appendChild(cancelBtn);

            document.body.appendChild(menu);

            // Focus the input field
            input.focus();

            // Close menu when clicking elsewhere
            const closeMenu = (e) => {
                if (!menu.contains(e.target)) {
                    menu.remove();
                    document.removeEventListener('click', closeMenu);
                }
            };
            setTimeout(() => {
                document.addEventListener('click', closeMenu);
            }, 100);
        }

        // Function to rename a friend
        function renameFriend(friend, newName) {
            if (!newName.trim()) {
                alert('Name cannot be empty');
                return;
            }

            // Update the friend's display name
            friend.displayName = newName.trim();

            // Save to localStorage
            saveData();

            // Refresh the contacts list
            renderContacts();

            addSystemMessage(`Renamed ${friend.username} to ${newName}`);
        }

        // Render friend requests
        function renderFriendRequests() {
            const container = document.getElementById('friendRequestsContainer');
            container.innerHTML = '';

            const pendingRequests = friendRequests.filter(request =>
                request.toUserId === currentUserId && request.status === 'pending'
            );

            if (pendingRequests.length === 0) {
                container.innerHTML = '<div class="contact-item"><div class="contact-info"><div class="contact-name">No pending friend requests</div><div class="contact-status">Check back later</div></div></div>';
                return;
            }

            pendingRequests.forEach(request => {
                const requester = getUserById(request.fromUserId);
                if (!requester) return;

                const requestElement = document.createElement('div');
                requestElement.className = 'friend-request-item';
                requestElement.innerHTML = `
                    <div class="request-info">
                        <div class="contact-avatar">${requester.username.charAt(0)}</div>
                        <div>
                            <div class="contact-name">${requester.username}</div>
                            <div class="contact-status">wants to be your friend</div>
                        </div>
                    </div>
                    <div class="request-actions">
                        <button class="request-action-btn accept-btn" onclick="acceptFriendRequest('${request.id}')">
                            <i class="fas fa-check"></i> Accept
                        </button>
                        <button class="request-action-btn decline-btn" onclick="declineFriendRequest('${request.id}')">
                            <i class="fas fa-times"></i> Decline
                        </button>
                    </div>
                `;

                container.appendChild(requestElement);
            });
        }

        // Get user by internal ID
        function getUserById(internalId) {
            // Check friends first
            let user = friends.find(f => f.id === internalId);
            if (user) return user;

            // Then check contacts
            user = contacts.find(c => c.id === internalId);
            if (user) return user;

            return null;
        }

        // Get user by public ID
        function getUserByPublicId(publicId) {
            // Check friends first
            let user = friends.find(f => f.publicId === publicId);
            if (user) return user;

            // Then check contacts
            user = contacts.find(c => c.publicId === publicId);
            if (user) return user;

            return null;
        }

        // Toggle friend requests view
        function toggleFriendRequests() {
            const section = document.getElementById('friendRequestsSection');
            const chatContainer = document.getElementById('chatContainer');

            if (section.style.display === 'none' || !section.style.display) {
                section.style.display = 'block';
                chatContainer.style.display = 'none';
            } else {
                section.style.display = 'none';
                chatContainer.style.display = 'flex';
                chatContainer.style.flexDirection = 'column';
            }
        }

        // Toggle appearance settings
        function toggleAppearanceSettings() {
            const section = document.getElementById('appearanceSettings');
            const chatContainer = document.getElementById('chatContainer');

            if (section.style.display === 'none' || !section.style.display) {
                section.style.display = 'block';
                chatContainer.style.display = 'none';
            } else {
                section.style.display = 'none';
                chatContainer.style.display = 'flex';
                chatContainer.style.flexDirection = 'column';
            }
        }

        // Apply customizations
        function applyCustomizations() {
            const themeColor = document.getElementById('themeColor').value;
            const bgColor = document.getElementById('bgColor').value;

            // Apply theme color to header
            document.querySelector('.header').style.background = `linear-gradient(135deg, ${themeColor} 0%, ${darkenColor(themeColor, 20)} 100%)`;

            // Apply background color to body
            document.body.style.background = `linear-gradient(135deg, ${bgColor} 0%, ${lightenColor(bgColor, 10)} 100%)`;

            // Save customizations
            localStorage.setItem('customTheme', JSON.stringify({
                themeColor: themeColor,
                bgColor: bgColor
            }));

            addSystemMessage('Customizations applied!');
        }

        // Helper function to darken a color
        function darkenColor(color, percent) {
            let R = parseInt(color.substring(1, 3), 16);
            let G = parseInt(color.substring(3, 5), 16);
            let B = parseInt(color.substring(5, 7), 16);

            R = parseInt(R * (100 - percent) / 100);
            G = parseInt(G * (100 - percent) / 100);
            B = parseInt(B * (100 - percent) / 100);

            R = (R < 0) ? 0 : R;
            G = (G < 0) ? 0 : G;
            B = (B < 0) ? 0 : B;

            R = Math.floor(R).toString(16).padStart(2, '0');
            G = Math.floor(G).toString(16).padStart(2, '0');
            B = Math.floor(B).toString(16).padStart(2, '0');

            return `#${R}${G}${B}`;
        }

        // Helper function to lighten a color
        function lightenColor(color, percent) {
            let R = parseInt(color.substring(1, 3), 16);
            let G = parseInt(color.substring(3, 5), 16);
            let B = parseInt(color.substring(5, 7), 16);

            R = parseInt(R + (255 - R) * (percent / 100));
            G = parseInt(G + (255 - G) * (percent / 100));
            B = parseInt(B + (255 - B) * (percent / 100));

            R = (R > 255) ? 255 : R;
            G = (G > 255) ? 255 : G;
            B = (B > 255) ? 255 : B;

            R = Math.floor(R).toString(16).padStart(2, '0');
            G = Math.floor(G).toString(16).padStart(2, '0');
            B = Math.floor(B).toString(16).padStart(2, '0');

            return `#${R}${G}${B}`;
        }

        // Send friend request
        function sendFriendRequest() {
            if (!selectedContact) {
                alert('Please select a contact to send a friend request to');
                return;
            }

            // Check if already friends
            if (friends.some(f => f.id === selectedContact.id)) {
                alert('You are already friends with this user');
                return;
            }

            // Check if already sent a request
            if (friendRequests.some(r => r.fromUserId === currentUserId && r.toUserId === selectedContact.id && r.status === 'pending')) {
                alert('You have already sent a friend request to this user');
                return;
            }

            server.sendFriendRequest(selectedContact.id);
        }

        // Accept friend request
        function acceptFriendRequest(requestId) {
            server.acceptFriendRequest(requestId);
        }

        // Decline friend request
        function declineFriendRequest(requestId) {
            server.declineFriendRequest(requestId);
        }

        // Generate a short, simple public ID for the user
        function generatePublicId() {
            // Generate a 6-character alphanumeric ID
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; // Excluding similar-looking characters
            let result = '';
            for (let i = 0; i < 6; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        // Create account
        function createAccount() {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!username || !email || !password) {
                alert('Please fill in all fields');
                return;
            }

            // Generate a short, simple public ID for the user
            const publicId = generatePublicId();

            // Create user object
            const userObj = {
                id: Date.now().toString(), // Internal ID
                publicId: publicId, // Public ID for friend connections
                username: username,
                email: email,
                createdAt: new Date().toISOString()
            };

            // Save to Firestore for searchability
            db.collection('users').doc(userObj.id).set({
                username: username,
                publicId: publicId.toUpperCase(),
                email: email,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                status: 'online'
            }).then(() => {
                console.log('User saved to Firestore');
            }).catch(error => {
                console.error('Error saving user to Firestore:', error);
            });

            // Store in localStorage
            localStorage.setItem('currentUser', JSON.stringify(userObj));
            localStorage.setItem('friends', JSON.stringify([]));
            localStorage.setItem('friendRequests', JSON.stringify([]));

            // Set current user
            currentUserId = userObj.id;
            currentUserPublicId = userObj.publicId;
            currentUsername = username;

            // Show chat area
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('chatArea').classList.remove('hidden');

            // Connect to simulated server
            server.connect();

            addSystemMessage(`Welcome to Monster Browser chat, ${username}! Your public ID is ${publicId}. Share this ID with friends to connect.`);

            // Update the public ID display and profile card
            setTimeout(function() {
                const publicIdDisplay = document.getElementById('publicIdDisplay');
                if (publicIdDisplay) {
                    publicIdDisplay.textContent = publicId.toUpperCase();
                }
                // Update profile card
                updateProfileCard();
            }, 500);
        }

        // Sign in
        function signIn() {
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            if (!username || !email || !password) {
                alert('Please fill in all fields');
                return;
            }

            // In a real implementation, this would authenticate with the server
            // For simulation, we'll check localStorage

            const storedUserStr = localStorage.getItem('currentUser');
            if (!storedUserStr) {
                alert('No account found. Please create an account first.');
                return;
            }

            const storedUser = JSON.parse(storedUserStr);
            const decodedUsername = translator.advancedDecode(storedUser.username);
            const decodedEmail = translator.advancedDecode(storedUser.email);
            const decodedPassword = translator.advancedDecode(storedUser.password);

            if ((decodedUsername === username || decodedEmail === email) && decodedPassword === password) {
                // Successful login
                currentUserId = storedUser.id;

                // Handle case where publicId might not exist in older user records
                if (!storedUser.publicId) {
                    // Generate a new public ID for the user
                    const newPublicId = generatePublicId();
                    storedUser.publicId = newPublicId;

                    // Update the stored user object
                    localStorage.setItem('currentUser', JSON.stringify(storedUser));

                    currentUserPublicId = newPublicId;
                } else {
                    currentUserPublicId = storedUser.publicId;
                }

                currentUsername = decodedUsername;

                // Show chat area
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('chatArea').classList.remove('hidden');

                // Connect to simulated server
                server.connect();

                addSystemMessage(`Welcome back to Monster Browser chat, ${currentUsername}! Your public ID is ${currentUserPublicId}. Share this ID with friends to connect.`);
            } else {
                alert('Invalid credentials');
            }
        }

        // Send message
        // Profanity filtering system
        const profanityFilter = {
            // Bad words that should be censored
            badWords: [
                'kill', 'death', 'blood', 'zombie', 'ghost', 'demon', 'devil', 'hell', 'evil', 'dark',
                'scare', 'fear', 'terror', 'nightmare', 'haunt', 'curse', 'sinister', 'ominous', 'grim',
                'menace', 'threat', 'danger', 'poison', 'venom', 'toxic', 'fatal', 'lethal', 'murder',
                'slaughter', 'butcher', 'cannibal', 'vampire', 'werewolf', 'ghoul', 'phantom', 'wraith',
                'specter', 'apparition', 'poltergeist', 'exorcism', 'possession', 'occult', 'satanic',
                'satan', 'beast', 'monster', 'creature', 'abomination', 'atrocity', 'brutal', 'cruel',
                'violence', 'chaos', 'apocalypse', 'doom', 'ruin', 'destruction', 'annihilation',
                'extermination', 'genocide', 'holocaust', 'massacre', 'slaughter', 'carnage', 'bloodshed',
                'gore', 'gruesome', 'macabre', 'morbid', 'ghastly', 'hideous', 'repulsive', 'revolting',
                'disgusting', 'horrific', 'shocking', 'disturbing', 'unsettling', 'eerie', 'spooky',
                'creepy', 'chilling', 'frightening', 'petrifying', 'terrifying', 'harrowing', 'dreadful',
                'fearsome', 'formidable', 'intimidating', 'menacing', 'sinister', 'malicious', 'wicked',
                'vile', 'villain', 'villainous', 'corrupt', 'depraved', 'wicked', 'nefarious', 'diabolical',
                'asshole', 'bastard', 'bitch', 'bloody', 'bollocks', 'bullshit', 'cock', 'cum', 'cunt',
                'damn', 'damnit', 'dick', 'dildo', 'dyke', 'fuck', 'fucker', 'fucking', 'fucked',
                'goddamn', 'hell', 'horseshit', 'motherfucker', 'nigga', 'nigger', 'penis', 'piss',
                'pussy', 'queer', 'rape', 'rapist', 'sex', 'sexy', 'shit', 'shitty', 'slut', 'tit',
                'whore', 'wtf', 'crap', 'suck', 'sucks', 'stupid', 'dumb', 'idiot', 'retard', 'gay',
                'fag', 'faggot', 'damn', 'crap', 'hell', 'hades', 'satan', 'devil', 'demons', 'evil'
            ],

            // Religious terms that should be treated carefully
            religiousTerms: [
                'allah', 'god', 'jesus', 'christ', 'buddha', 'muhammad', 'prophet', 'holy', 'bible',
                'quran', 'koran', 'torah', 'religion', 'faith', 'pray', 'prayer', 'worship', 'church',
                'mosque', 'temple', 'synagogue', 'sacred', 'bless', 'blessing', 'amen', 'hallelujah',
                'allah akbar', 'father', 'son', 'spirit', 'heaven', 'paradise', 'hell', 'satan', 'devil'
            ],

            // Censor a word with symbols
            censorWord: function(word) {
                // Choose a random censorship symbol
                const symbols = ['*', '+', '-', '#', '~', '?'];
                const symbol = symbols[Math.floor(Math.random() * symbols.length)];

                // Replace letters with the chosen symbol
                return word.replace(/[a-zA-Z]/g, symbol);
            },

            // Filter a message for profanity
            filterMessage: function(message) {
                let filteredMessage = message;

                // Process each bad word
                this.badWords.forEach(word => {
                    // Create a case-insensitive regex for the word
                    const regex = new RegExp('\\b' + word + '\\b', 'gi');

                    // Replace the word with censored version
                    filteredMessage = filteredMessage.replace(regex, this.censorWord(word));
                });

                return filteredMessage;
            }
        };

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();

            if (!selectedContact) {
                console.warn(' [Send] No contact selected');
                alert('Please select a contact to send a message to');
                return;
            }

            console.log(' [Send] Preparing to send message...');
            console.log('  - Contact:', selectedContact.username);
            console.log('  - Contact ID:', selectedContact.id);
            console.log('  - Message:', message.substring(0, 50) + (message.length > 50 ? '...' : ''));

            // Allow self-chat for testing, otherwise check if selected contact is a friend
            const isSelfChat = selectedContact.isSelf;
            const isFriend = isSelfChat || friends.some(f => f.id === selectedContact.id);

            if (!isFriend) {
                console.warn(' [Send] Contact is not a friend');
                alert('You can only send messages to friends. Send a friend request first.');
                return;
            }

            if (message) {
                // Apply profanity filtering to the message
                const filteredMessage = profanityFilter.filterMessage(message);
                console.log(' [Filter] Message after profanity filter:', filteredMessage.substring(0, 50) + (filteredMessage.length > 50 ? '...' : ''));

                //  Nova AI is DISABLED - No AI observation or interference

                // Encode the message
                console.log(' [Encoding] Encoding message...');
                const encodedMessage = translator.advancedEncode(filteredMessage);
                console.log(' [Encoding] Message encoded, length:', encodedMessage.length);

                // Test decoding to verify it works
                try {
                    const testDecode = translator.advancedDecode(encodedMessage);
                    if (testDecode === filteredMessage) {
                        console.log(' [Encoding] Decode test passed - emojis/Arabic supported');
                    } else {
                        console.warn(' [Encoding] Decode test failed - data mismatch');
                    }
                } catch (e) {
                    console.error(' [Encoding] Decode test error:', e.message);
                }

                // In a real implementation, this would send via server.sendMessage()
                // For simulation, we'll just display locally and trigger a response
                console.log(' [Display] Adding message to chat view');
                addMessage(currentUsername, filteredMessage, true);

                // Always send to simulated server (including self-chat for testing)
                console.log(' [Server] Sending to simulated server...');
                // For voice messages, we need to send the encoded audio data
                if (typeof filteredMessage === 'string' && filteredMessage.startsWith('data:')) {
                    // This is a voice message, send the data URL directly without encryption
                    server.sendMessage(selectedContact.id, filteredMessage, false); // Don't encrypt voice data
                    console.log(' [Voice] Voice message sent');
                } else {
                    // This is a text message, send encrypted
                    server.sendMessage(selectedContact.id, filteredMessage);
                    console.log(' [Text] Text message sent');
                }

                // Visual feedback
                input.value = '';
                input.focus();

                // Add subtle animation to the send button
                const sendButton = document.getElementById('sendButton');
                sendButton.style.transform = 'scale(0.95)';
                setTimeout(() => {
                    sendButton.style.transform = '';
                }, 100);

                // Save message to Firestore with proper private chat logic
                console.log(' [Firestore] Saving message to Firestore...');
                const chatId = generateChatId(currentUserId, selectedContact.id);

                saveMessageToFirestore(currentUsername, currentUserId, filteredMessage, selectedContact.id, chatId)
                    .then(() => {
                        console.log(' [Firestore] Message successfully written!');
                    })
                    .catch(error => {
                        console.error(' [Firestore] Failed to write message:', error.message);
                        console.error(' [Help] Check Firestore security rules in Firebase Console');
                    });
            }
        }

        // Save message to Firestore with proper private chat logic
        async function saveMessageToFirestore(sender, senderId, message, receiverId, chatId) {
            console.log(' [Firestore] Preparing to save message...');
            console.log('  - Sender:', sender);
            console.log('  - Sender ID:', senderId);
            console.log('  - Receiver ID:', receiverId);
            console.log('  - Chat ID:', chatId);
            console.log('  - Message length:', message.length);
            
            try {
                const messageData = {
                    sender: sender,
                    senderId: senderId,
                    message: message,
                    receiverId: receiverId,
                    chatId: chatId, // Unique chat session ID
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    read: false
                };
                
                console.log(' [Firestore] Writing message to collection...');
                const docRef = await db.collection('messages').add(messageData);
                
                console.log(' [Firestore] Message saved successfully!');
                console.log('  - Document ID:', docRef.id);
                console.log('  - Timestamp:', new Date().toISOString());
                
                // Log the encoded message for debugging
                if (message !== translator.advancedDecode(message)) {
                    console.log(' [Encoding] Message was encoded');
                    try {
                        const decoded = translator.advancedDecode(message);
                        console.log(' [Decoded preview]:', decoded.substring(0, 50) + (decoded.length > 50 ? '...' : ''));
                    } catch (e) {
                        console.log(' [Encoding] Could not decode for preview');
                    }
                }
                
                return docRef;
            } catch (error) {
                console.error(' [Firestore] Critical Error saving message:', error.message);
                console.error('  - Error code:', error.code);
                console.error('  - Check Firestore security rules and permissions');
                
                // Provide specific error guidance
                if (error.code === 'permission-denied') {
                    console.error(' [Permissions] Firestore permission denied!');
                    console.error(' [Help] Check your Firestore rules:');
                    console.error('  match /messages/{messageId} {');
                    console.error('    allow read, write: if true;  // For testing');
                    console.error('  }');
                } else if (error.code === 'unavailable') {
                    console.error(' [Network] Network error - check your connection');
                } else if (error.code === 'invalid-argument') {
                    console.error(' [Data] Invalid data format');
                }
                
                throw error;
            }
        }

        // Listen for new messages from Firestore for a specific chat
        let messagesUnsubscribe = null; // Store unsubscribe function

        function listenForMessages(chatId) {
            console.log(' [Firestore] Setting up message listener...');
            console.log('  - Chat ID:', chatId);

            // Unsubscribe from previous chat if exists
            if (messagesUnsubscribe) {
                console.log(' [Listener] Unsubscribing from previous chat');
                messagesUnsubscribe();
                messagesUnsubscribe = null;
            }

            if (!chatId) {
                console.warn(' [Listener] No chatId provided, skipping listener setup');
                return;
            }

            // Clear current chat display
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';

            console.log(' [Firestore] Querying messages where chatId ==', chatId);

            // Listen to messages for this specific chat
            messagesUnsubscribe = db.collection('messages')
              .where('chatId', '==', chatId)
              .orderBy('timestamp', 'asc')
              .onSnapshot(snapshot => {
                  console.log(' [Listener] Received snapshot with', snapshot.docs.length, 'message(s)');

                  snapshot.docChanges().forEach(change => {
                      if (change.type === 'added') {
                          const msg = change.doc.data();
                          console.log(' [New Message] Type:', change.type);
                          console.log('  - From:', msg.sender);
                          console.log('  - Sender ID:', msg.senderId);
                          console.log('  - Is mine:', msg.senderId === currentUserId);

                          try {
                              // Determine if message is sent or received
                              const isSent = msg.senderId === currentUserId;

                              console.log(' [Message ID Check]');
                              console.log('  - msg.senderId:', msg.senderId);
                              console.log('  - currentUserId:', currentUserId);
                              console.log('  - Are they equal?', msg.senderId === currentUserId);
                              console.log('  - isSent:', isSent);

                              if (isSent) {
                                  console.log(' [Display] Showing MY message (outgoing)');
                                  console.log('  - This message was sent from YOUR account');
                                  addMessage(msg.sender, msg.message, true, false);
                              } else {
                                  console.log(' [Display] Showing THEIR message (incoming)');
                                  console.log('  - This message was sent from THE OTHER USER');
                                  addMessage(msg.sender, msg.message, false, true);
                              }
                          } catch (error) {
                              console.error(' [Decode] Error processing message:', error.message);
                              console.error('  - Message ID:', change.doc.id);
                              console.error('  - Sender:', msg.sender);
                              console.error('  - Skipping this message to prevent chat crash');
                              
                              // Add a system message about the skipped message
                              const errorDiv = document.createElement('div');
                              errorDiv.className = 'message system';
                              errorDiv.style.background = 'rgba(255, 0, 0, 0.1)';
                              errorDiv.style.border = '1px solid #ff0000';
                              errorDiv.innerHTML = `
                                  <div class="message-content">
                                       Message from ${msg.sender} could not be decoded (ID: ${change.doc.id.substring(0, 8)}...)
                                      <br><small>This message may have been sent with an older encoding format.</small>
                                  </div>
                              `;
                              chatContainer.appendChild(errorDiv);
                              chatContainer.scrollTop = chatContainer.scrollHeight;
                          }
                      }
                  });
                  
                  // Auto-scroll to bottom after loading messages
                  setTimeout(() => {
                      chatContainer.scrollTop = chatContainer.scrollHeight;
                  }, 100);
              }, error => {
                  console.error(' [Firestore] Critical Error listening to messages:', error.message);
                  console.error('  - Error code:', error.code);

                  if (error.code === 'permission-denied') {
                      console.error(' [Permissions] Cannot access messages collection');
                      console.error(' [Help] Check Firestore security rules');
                  }
                  
                  addSystemMessage('Error loading messages. Please check your connection.');
              });
              
            console.log(' [Listener] Message listener active');
        }

        // Generate a unique chat ID for a private conversation between two users
        function generateChatId(userId1, userId2) {
            // Sort IDs to ensure consistent chat ID regardless of who initiates
            const sortedIds = [userId1, userId2].sort();
            const chatId = `chat_${sortedIds[0]}_${sortedIds[1]}`;
            
            console.log(' [ChatID] Generated chat ID:');
            console.log('  - User 1:', userId1);
            console.log('  - User 2:', userId2);
            console.log('  - Sorted:', sortedIds);
            console.log('  - Chat ID:', chatId);
            
            return chatId;
        }

        // Open chat with self for testing message bubbles
        function openChatWithSelf() {
            console.log(' Opening chat with self for testing...');

            // Create a self-contact object
            const selfContact = {
                id: currentUserId,
                username: currentUsername + ' (Self)',
                publicId: currentUserPublicId,
                status: 'online',
                displayName: currentUsername,
                isSelf: true
            };

            // Set as selected contact
            selectedContact = selfContact;
            selectedChat = currentUserId;

            // Initialize chat session with self
            const chatId = generateChatId(currentUserId, currentUserId);
            listenForMessages(chatId);

            // Close friends menu if open
            const friendsMenu = document.getElementById('friendsMenu');
            if (friendsMenu && friendsMenu.classList.contains('open')) {
                closeFriendsMenu();
            }

            // Deselect other contacts
            document.querySelectorAll('.contact-item').forEach(item => {
                item.classList.remove('selected');
            });

            addSystemMessage(` Opened self-chat for testing. Send messages to test the chat interface!`);
            addSystemMessage(` Messages sent here will only be visible to you. Perfect for testing message bubbles, emojis, and formatting!`);
        }

        // TEST FUNCTION: Open chat with specific user ID (for testing with two IDs)
        function openTestChatWithUserId(testUserId, testUsername, testPublicId) {
            console.log(' [TEST] Opening test chat with specific user ID...');
            console.log('  - Test User ID:', testUserId);
            console.log('  - Test Username:', testUsername);
            console.log('  - Test Public ID:', testPublicId);
            console.log('  - Your ID:', currentUserId);
            console.log('  - Your Public ID:', currentUserPublicId);

            // Create test contact object
            const testContact = {
                id: testUserId,
                username: testUsername,
                publicId: testPublicId,
                status: 'online',
                displayName: testUsername,
                isSelf: false
            };

            // Set as selected contact
            selectedContact = testContact;
            selectedChat = testUserId;

            // Generate chat ID with proper sorting
            const chatId = generateChatId(currentUserId, testUserId);
            console.log(' [ChatID] Test chat ID:', chatId);

            // Initialize chat session
            listenForMessages(chatId);

            // Close friends menu if open
            const friendsMenu = document.getElementById('friendsMenu');
            if (friendsMenu && friendsMenu.classList.contains('open')) {
                closeFriendsMenu();
            }

            addSystemMessage(` TEST CHAT: Opened chat with ${testUsername} (${testPublicId})`);
            addSystemMessage(` Chat ID: ${chatId}`);
            addSystemMessage(` You can now send test messages between your two accounts!`);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function addMessage(username, message, isSent, isReceivedFromOther = false) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');

            // Determine the correct class based on whether it's sent or received
            if (isReceivedFromOther) {
                messageDiv.className = 'message received';
            } else {
                messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
            }

            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const dateString = now.toLocaleDateString();

            // Create message content with clickable links
            let formattedMessage = message;
            // Simple URL detection and formatting
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            formattedMessage = formattedMessage.replace(urlRegex, url => `<a href="${url}" target="_blank" style="color: #4fc3f7; text-decoration: underline;">${url}</a>`);

            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="username">${username}</span>
                    <div class="message-meta">
                        <span class="timestamp">${timeString}</span>
                        <span class="datestamp">${dateString}</span>
                        ${isSent ? '<span class="message-status" title="Delivered"><i class="fas fa-check-double"></i></span>' : ''}
                    </div>
                </div>
                <div class="message-content">${formattedMessage}</div>
                <div class="message-reactions">
                    <span class="reaction" onclick="addReaction(this, '')"></span>
                    <span class="reaction" onclick="addReaction(this, '')"></span>
                    <span class="reaction" onclick="addReaction(this, '')"></span>
                    <span class="reaction" onclick="addReaction(this, '')"></span>
                    <span class="reaction" onclick="addReaction(this, '')"></span>
                </div>
            `;

            // Add the message to the container
            chatContainer.appendChild(messageDiv);

            // Force a reflow to ensure the element is rendered
            messageDiv.offsetHeight;

            // Always scroll to the bottom to behave like messenger
            // Use smooth scrolling for better UX
            chatContainer.scrollTo({
                top: chatContainer.scrollHeight,
                behavior: 'smooth'
            });

            //  Nova AI is DISABLED - No AI observation of incoming messages
        }

        function addSystemMessage(message) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message system';

            const now = new Date();
            const timeString = now.toLocaleTimeString();
            const dateString = now.toLocaleDateString();

            messageDiv.innerHTML = `
                <div class="message-header">
                    <span class="username">SYSTEM</span>
                    <div class="message-meta">
                        <span class="timestamp">${timeString}</span>
                        <span class="datestamp">${dateString}</span>
                    </div>
                </div>
                <div class="message-content">${message}</div>
            `;

            // Add the message to the container
            chatContainer.appendChild(messageDiv);

            // Force a reflow to ensure the element is rendered
            messageDiv.offsetHeight;

            // Always scroll to the bottom to behave like messenger
            // Use smooth scrolling for better UX
            chatContainer.scrollTo({
                top: chatContainer.scrollHeight,
                behavior: 'smooth'
            });
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('friends', JSON.stringify(friends));
            localStorage.setItem('friendRequests', JSON.stringify(friendRequests));
        }

        // Tab switching functionality
        document.addEventListener('DOMContentLoaded', function() {
            const tabs = document.querySelectorAll('.panel-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));

                    // Add active class to clicked tab
                    this.classList.add('active');

                    // Update current tab
                    currentTab = this.getAttribute('data-tab');

                    // Re-render contacts
                    renderContacts();
                });
            });

            console.log(' [Init] DOM loaded, setting up Firestore listener...');
            
            // Initialize Firestore listener immediately
            // Note: Will wait for user to select a contact before actually listening
            setTimeout(() => {
                console.log(' [Init] Firestore listener ready');
            }, 500);
        });

        // Toggle emoji panel
        function toggleEmojiPanel() {
            const emojiPanel = document.getElementById('emojiPanel');
            const translatePanel = document.getElementById('translatePanel');

            // Close translate panel if open
            if (translatePanel.style.display === 'block') {
                translatePanel.style.display = 'none';
            }

            if (emojiPanel.style.display === 'none' || !emojiPanel.style.display) {
                emojiPanel.style.display = 'block';

                // Close when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', closeEmojiPanelOnClickOutside);
                }, 100);
            } else {
                emojiPanel.style.display = 'none';
            }
        }

        // Toggle translate panel
        function toggleTranslatePanel() {
            const translatePanel = document.getElementById('translatePanel');
            const emojiPanel = document.getElementById('emojiPanel');

            // Close emoji panel if open
            if (emojiPanel.style.display === 'block') {
                emojiPanel.style.display = 'none';
            }

            if (translatePanel.style.display === 'none' || !translatePanel.style.display) {
                translatePanel.style.display = 'block';

                // Close when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', closeTranslatePanelOnClickOutside);
                }, 100);
            } else {
                translatePanel.style.display = 'none';
            }
        }

        // Close emoji panel when clicking outside
        function closeEmojiPanelOnClickOutside(event) {
            const emojiPanel = document.getElementById('emojiPanel');
            const emojiButton = document.querySelector('.action-button[onclick="toggleEmojiPanel()"]');

            if (!emojiPanel.contains(event.target) && !emojiButton.contains(event.target)) {
                emojiPanel.style.display = 'none';
                document.removeEventListener('click', closeEmojiPanelOnClickOutside);
            }
        }

        // Close translate panel when clicking outside
        function closeTranslatePanelOnClickOutside(event) {
            const translatePanel = document.getElementById('translatePanel');
            const translateButton = document.querySelector('.action-button[onclick="toggleTranslatePanel()"]');

            if (!translatePanel.contains(event.target) && !translateButton.contains(event.target)) {
                translatePanel.style.display = 'none';
                document.removeEventListener('click', closeTranslatePanelOnClickOutside);
            }
        }

        // Insert emoji into message input
        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            input.value += emoji;
            input.focus();
        }

        // Handle typing status indicator
        let typingTimer;
        function handleTypingStatus() {
            if (!selectedContact) return;

            const input = document.getElementById('messageInput');
            const typingIndicator = document.getElementById('typingIndicator');
            const typingText = document.getElementById('typingText');

            typingText.textContent = currentUsername;

            // Show typing indicator
            typingIndicator.style.display = 'block';

            // Clear existing timer
            clearTimeout(typingTimer);

            // Set new timer to hide indicator after 2 seconds of inactivity
            typingTimer = setTimeout(() => {
                typingIndicator.style.display = 'none';
            }, 2000);
        }

        // Add reaction to a message
        function addReaction(reactionElement, emoji) {
            // Toggle the reaction - if it's already selected, remove it; otherwise add it
            if (reactionElement.classList.contains('selected')) {
                reactionElement.classList.remove('selected');
                reactionElement.style.background = '';
            } else {
                reactionElement.classList.add('selected');
                reactionElement.style.background = 'var(--primary-color)';
                reactionElement.style.color = 'white';

                // Add more dramatic animation effect
                reactionElement.animate([
                    { transform: 'scale(1)', boxShadow: 'none' },
                    { transform: 'scale(1.8)', boxShadow: '0 0 15px rgba(255, 0, 0, 0.8)' },
                    { transform: 'scale(1.3)', boxShadow: '0 0 10px rgba(255, 0, 0, 0.6)' },
                    { transform: 'scale(1.5)', boxShadow: '0 0 12px rgba(255, 0, 0, 0.7)' },
                    { transform: 'scale(1)', boxShadow: 'none' }
                ], {
                    duration: 600,
                    iterations: 1
                });

                // Add a ripple effect to the parent message
                const messageDiv = reactionElement.closest('.message');
                if (messageDiv) {
                    messageDiv.classList.add('new-message');
                    setTimeout(() => {
                        messageDiv.classList.remove('new-message');
                    }, 600);
                }
            }

            // Show a temporary notification with animation
            const notification = document.createElement('div');
            notification.textContent = `You reacted with ${emoji}`;
            notification.style.position = 'fixed';
            notification.style.bottom = '20px';
            notification.style.right = '20px';
            notification.style.backgroundColor = '#8b0000';
            notification.style.color = 'white';
            notification.style.padding = '12px 20px';
            notification.style.borderRadius = '8px';
            notification.style.zIndex = '10000';
            notification.style.boxShadow = '0 0 20px rgba(255, 0, 0, 0.6)';
            notification.style.opacity = '0';
            notification.style.transform = 'translateY(20px)';
            notification.style.transition = 'all 0.3s ease';
            document.body.appendChild(notification);

            // Fade in the notification
            setTimeout(() => {
                notification.style.opacity = '1';
                notification.style.transform = 'translateY(0)';
            }, 10);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(20px)';
                setTimeout(() => {
                    document.body.removeChild(notification);
                }, 300);
            }, 2000);
        }

        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Create a message with file info
            const fileInfo = {
                name: file.name,
                size: formatFileSize(file.size),
                type: file.type,
                timestamp: new Date().toISOString()
            };

            // Create a file message
            const fileMessage = `[FILE] ${fileInfo.name} (${fileInfo.size})`;

            // Send the file message
            addMessage(currentUsername, fileMessage, true);

            // In a real implementation, you would upload the file to the server
            // For now, we'll just simulate the upload
            simulateFileUpload(file);
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Simulate file upload to server
        function simulateFileUpload(file) {
            // Show upload progress
            addSystemMessage(`Uploading file: ${file.name}...`);

            // Simulate upload delay
            setTimeout(() => {
                addSystemMessage(`File uploaded successfully: ${file.name}`);

                // Reset file input
                document.getElementById('fileInput').value = '';
            }, 2000);
        }

        // Toggle translate panel
        function toggleTranslatePanel() {
            const translatePanel = document.getElementById('translatePanel');
            const emojiPanel = document.getElementById('emojiPanel');

            // Hide emoji panel if open
            if (emojiPanel.style.display === 'block') {
                emojiPanel.style.display = 'none';
            }

            if (translatePanel.style.display === 'none' || !translatePanel.style.display) {
                translatePanel.style.display = 'block';

                // Close when clicking outside
                setTimeout(() => {
                    document.addEventListener('click', closeTranslatePanelOnClickOutside);
                }, 100);
            } else {
                translatePanel.style.display = 'none';
            }
        }

        // Close translate panel when clicking outside
        function closeTranslatePanelOnClickOutside(event) {
            const translatePanel = document.getElementById('translatePanel');
            const translateButton = document.querySelector('.action-button[title="Translate"]');

            if (!translatePanel.contains(event.target) && !translateButton.contains(event.target)) {
                translatePanel.style.display = 'none';
                document.removeEventListener('click', closeTranslatePanelOnClickOutside);
            }
        }

        // Placeholder function for downloading files
        function downloadFile(fileName) {
            addSystemMessage(`Downloading file: ${fileName}... (Feature not implemented in demo)`);
        }

        // Perform translation
        function performTranslation() {
            const inputText = document.getElementById('translateInput').value;
            const sourceLang = document.getElementById('sourceLang').value;
            const targetLang = document.getElementById('targetLang').value;

            if (!inputText) {
                document.getElementById('translateOutput').value = '';
                return;
            }

            // In a real implementation, this would call a translation API
            // For now, we'll simulate a translation

            // Show translating message
            addSystemMessage('Translating...');

            // Simulate API call delay
            setTimeout(() => {
                // For demo purposes, we'll just reverse the text
                // In a real implementation, you would call an actual translation service
                const translatedText = inputText.split('').reverse().join('');

                document.getElementById('translateOutput').value = translatedText;

                // Also add to chat if requested
                if (confirm('Add translation to chat?')) {
                    addMessage('Translator', `Translation: ${translatedText}`, false, true);
                }
            }, 1000);
        }

        // Swap source and target languages
        function swapLanguages() {
            const sourceLang = document.getElementById('sourceLang');
            const targetLang = document.getElementById('targetLang');
            const sourceInput = document.getElementById('translateInput');
            const targetOutput = document.getElementById('translateOutput');

            // Swap language selections
            const tempLang = sourceLang.value;
            sourceLang.value = targetLang.value;
            targetLang.value = tempLang;

            // Swap text values
            const tempText = sourceInput.value;
            sourceInput.value = targetOutput.value;
            targetOutput.value = tempText;

            // Perform translation with swapped languages
            performTranslation();
        }

        // Add translation to chat
        function addTranslationToChat() {
            const targetOutput = document.getElementById('translateOutput').value;
            if (targetOutput) {
                addMessage('Translator', `Translation: ${targetOutput}`, false, true);
                // Close the translation panel after adding to chat
                document.getElementById('translatePanel').style.display = 'none';
            } else {
                alert('No translation to add to chat');
            }
        }

        // Video calling functionality
        let localStream;
        let remoteStream;
        let isVideoVisible = true;
        let isFaceMasked = false;
        let selectedAvatar = null;
        let isCameraConnected = false;

        // Predefined avatar options
        const avatarOptions = ['', '', '', ' pumpkin', '', '', '', '', '', ''];

        // Check camera availability
        async function checkCameraAvailability() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const videoDevices = devices.filter(device => device.kind === 'videoinput');

                if (videoDevices.length === 0) {
                    console.warn('No cameras found');
                    return false;
                }

                console.log(`Found ${videoDevices.length} camera(s)`);
                return true;
            } catch (err) {
                console.error('Error checking camera availability:', err);
                return false;
            }
        }

        // Verify camera connection
        async function verifyCameraConnection() {
            try {
                // Try to access the camera briefly to verify it's working
                const tempStream = await navigator.mediaDevices.getUserMedia({
                    video: { width: { ideal: 640 }, height: { ideal: 480 } },
                    audio: false
                });

                // Stop all tracks to release the camera
                tempStream.getTracks().forEach(track => track.stop());

                isCameraConnected = true;
                console.log('Camera connection verified successfully');
                return true;
            } catch (err) {
                console.error('Camera connection failed:', err);
                isCameraConnected = false;
                return false;
            }
        }

        async function startVideoCall() {
            if (!selectedContact) {
                alert('Please select a contact to start a video call with');
                return;
            }

            // Check if selected contact is a friend
            const isFriend = friends.some(f => f.id === selectedContact.id);
            if (!isFriend) {
                alert('You can only make video calls to friends. Send a friend request first.');
                return;
            }

            // Verify camera connection before starting the call
            const cameraAvailable = await checkCameraAvailability();
            if (!cameraAvailable) {
                alert('No camera found. Please connect a camera to make video calls.');
                return;
            }

            const cameraWorking = await verifyCameraConnection();
            if (!cameraWorking) {
                alert('Camera is not working properly. Please check your camera settings and permissions.');
                return;
            }

            try {
                // Request camera and microphone access
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });

                localStream = stream;
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = stream;

                // Update camera status indicator to green (connected)
                updateCameraStatusIndicator(true);

                // Set up the call interface
                document.getElementById('callPartnerName').textContent = selectedContact.username;
                document.getElementById('videoCallInterface').style.display = 'flex';

                // Show avatar if face is masked
                if (isFaceMasked && selectedAvatar) {
                    document.getElementById('localAvatar').textContent = selectedAvatar;
                    document.getElementById('localAvatar').style.display = 'flex';
                    localVideo.style.display = 'none';
                }

                // In a real implementation, this would establish a WebRTC connection
                // For simulation, we'll just show a placeholder for remote video
                setTimeout(() => {
                    // Simulate remote video feed
                    document.getElementById('remoteAvatar').textContent = ''; // Default avatar
                    document.getElementById('remoteAvatar').style.display = 'flex';
                }, 2000);

                addSystemMessage(`Starting video call with ${selectedContact.username}...`);
            } catch (error) {
                console.error('Error accessing camera/microphone:', error);
                alert('Camera and microphone access denied. Please enable permissions to make video calls.');
            }
        }

        function endVideoCall() {
            // Stop all tracks in the local stream
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }

            // Reset video elements
            const localVideo = document.getElementById('localVideo');
            if (localVideo) {
                localVideo.srcObject = null;
            }

            // Hide the video call interface
            document.getElementById('videoCallInterface').style.display = 'none';

            // Update camera status indicator back to red (not connected)
            updateCameraStatusIndicator(false);

            addSystemMessage('Video call ended.');
        }

        function toggleVideo() {
            if (localStream) {
                const videoTracks = localStream.getVideoTracks();
                if (videoTracks.length > 0) {
                    videoTracks[0].enabled = !videoTracks[0].enabled;

                    const localVideo = document.getElementById('localVideo');
                    const localAvatar = document.getElementById('localAvatar');

                    if (videoTracks[0].enabled) {
                        // Show camera feed
                        isVideoVisible = true;
                        document.getElementById('videoToggleText').textContent = 'Hide Video';
                        if (isFaceMasked) {
                            localVideo.style.display = 'none';
                            localAvatar.style.display = 'flex';
                        } else {
                            localVideo.style.display = 'block';
                            localAvatar.style.display = 'none';
                        }
                    } else {
                        // Hide camera feed
                        isVideoVisible = false;
                        document.getElementById('videoToggleText').textContent = 'Show Video';
                        // Show avatar when video is disabled
                        localVideo.style.display = 'none';
                        localAvatar.style.display = 'flex';
                    }
                }
            }
        }

        function toggleFaceMask() {
            isFaceMasked = !isFaceMasked;

            const localVideo = document.getElementById('localVideo');
            const localAvatar = document.getElementById('localAvatar');

            if (isFaceMasked) {
                // Select a random avatar if none is selected
                if (!selectedAvatar) {
                    selectedAvatar = avatarOptions[Math.floor(Math.random() * avatarOptions.length)];
                }

                document.getElementById('localAvatar').textContent = selectedAvatar;
                document.getElementById('maskToggleText').textContent = 'Show Real Face';

                // Show avatar instead of video if video is enabled
                if (isVideoVisible) {
                    localVideo.style.display = 'none';
                    localAvatar.style.display = 'flex';
                }
            } else {
                document.getElementById('maskToggleText').textContent = 'Hide Face';

                // Show real video if video is enabled
                if (isVideoVisible) {
                    localVideo.style.display = 'block';
                    localAvatar.style.display = 'none';
                }
            }
        }

        // Function to select a specific avatar
        function selectAvatar(avatar) {
            selectedAvatar = avatar;
            document.getElementById('localAvatar').textContent = selectedAvatar;

            if (isFaceMasked) {
                document.getElementById('localAvatar').style.display = 'flex';
            }

            // Also update the remote avatar if needed
            if (isFaceMasked) {
                document.getElementById('remoteAvatar').textContent = selectedAvatar;
            }
        }

        // Function to show avatar selection panel
        function showAvatarSelection() {
            document.getElementById('avatarSelectionPanel').style.display = 'block';
        }

        // Function to hide avatar selection panel
        function hideAvatarSelection() {
            document.getElementById('avatarSelectionPanel').style.display = 'none';
        }

        // Close avatar selection when clicking outside
        document.addEventListener('click', function(event) {
            const panel = document.getElementById('avatarSelectionPanel');
            const button = document.querySelector('[onclick="showAvatarSelection()"]');

            if (panel.style.display === 'block' &&
                !panel.contains(event.target) &&
                !button.contains(event.target)) {
                hideAvatarSelection();
            }
        });

        // Security scanner functionality
        const securityScanner = {
            isActive: true,
            threatsFound: [],
            scanInterval: null,

            init: function() {
                // Start periodic scanning
                this.scanInterval = setInterval(() => {
                    this.scanForThreats();
                }, 5000); // Scan every 5 seconds
            },

            scanForThreats: function() {
                if (!this.isActive) return;

                // Check for potential threats in messages
                const messageElements = document.querySelectorAll('.message-content');
                messageElements.forEach(element => {
                    const text = element.textContent || element.innerText;
                    if (this.isThreateningContent(text)) {
                        this.reportThreat(text, element);
                    }
                });

                // Check for suspicious URLs
                const links = document.querySelectorAll('a');
                links.forEach(link => {
                    if (this.isSuspiciousLink(link.href)) {
                        this.reportThreat(`Suspicious link detected: ${link.href}`, link);
                    }
                });
            },

            isThreateningContent: function(text) {
                const threatKeywords = [
                    'hack', 'exploit', 'phish', 'malware', 'virus', 'trojan',
                    'spyware', 'ransomware', 'keylogger', 'rootkit', 'botnet',
                    'ddos', 'sql injection', 'xss', 'csrf', 'session hijacking',
                    'man-in-the-middle', 'social engineering', 'identity theft',
                    'credit card', 'ssn', 'password', 'login', 'account', 'bank'
                ];

                const lowerText = text.toLowerCase();
                return threatKeywords.some(keyword => lowerText.includes(keyword));
            },

            isSuspiciousLink: function(url) {
                const suspiciousPatterns = [
                    'free-money', 'get-rich', 'click-here', 'verify-account',
                    'urgent-action', 'suspicious-login', 'claim-prize',
                    'paypal-security', 'bank-alert', 'free-gift'
                ];

                const lowerUrl = url.toLowerCase();
                return suspiciousPatterns.some(pattern => lowerUrl.includes(pattern));
            },

            reportThreat: function(threat, element) {
                if (!this.threatsFound.includes(threat)) {
                    this.threatsFound.push(threat);
                    addSystemMessage(` SECURITY ALERT: Potential threat detected - ${threat}`);

                    // Highlight the threatening element
                    element.style.backgroundColor = 'rgba(255, 0, 0, 0.2)';
                    element.style.border = '2px solid #ff0000';
                    element.style.borderRadius = '5px';

                    // Add a warning icon
                    const warningIcon = document.createElement('span');
                    warningIcon.innerHTML = ' ';
                    warningIcon.style.color = '#ff0000';
                    element.appendChild(warningIcon);
                }
            },

            toggleScanning: function() {
                this.isActive = !this.isActive;
                if (this.isActive) {
                    addSystemMessage(' Security scanning activated');
                    this.updateStatusIndicator(true);
                } else {
                    addSystemMessage(' Security scanning deactivated');
                    this.updateStatusIndicator(false);
                }
            },

            updateStatusIndicator: function(isActive) {
                const indicator = document.getElementById('securityStatusIndicator');
                if (indicator) {
                    indicator.style.backgroundColor = isActive ? '#0be881' : '#ff4757'; // Green for active, red for inactive
                }
            }
        };

        // Initialize security scanner when page loads
        window.addEventListener('load', function() {
            securityScanner.init();
            securityScanner.updateStatusIndicator(securityScanner.isActive);
        });

        // Voice effect menu functions
        function toggleVoiceEffectMenu() {
            const menu = document.getElementById('voiceEffectMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function setVoiceEffect(effect) {
            voiceChanger.setVoice(effect);
            document.getElementById('voiceEffectMenu').style.display = 'none';
        }

        // Close voice effect menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('voiceEffectMenu');
            const button = document.getElementById('voiceEffectButton');

            if (menu.style.display === 'block' &&
                !menu.contains(event.target) &&
                !button.contains(event.target)) {
                menu.style.display = 'none';
            }
        });

        // Nova AI functions
        function toggleNovaMenu() {
            const menu = document.getElementById('novaMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        function toggleNovaMonitoring() {
            if (typeof novaChatMonitor !== 'undefined' && novaChatMonitor) {
                if (novaChatMonitor.isEnabled) {
                    novaChatMonitor.disableMonitoring();
                    document.getElementById('novaMonitoringStatus').textContent = 'OFF';
                    document.getElementById('novaMonitoringStatus').style.color = '#ff4757';
                    addSystemMessage('Nova AI monitoring disabled.');
                } else {
                    novaChatMonitor.enableMonitoring();
                    document.getElementById('novaMonitoringStatus').textContent = 'ON';
                    document.getElementById('novaMonitoringStatus').style.color = '#0be881';
                    addSystemMessage('Nova AI monitoring enabled.');
                }
            } else {
                addSystemMessage('Nova AI is not available. Please ensure nova-chat-monitor.js is loaded correctly.');
            }
        }

        function setNovaParticipation(mode) {
            if (typeof novaChatMonitor !== 'undefined' && novaChatMonitor) {
                novaChatMonitor.setParticipationMode(mode);
                addSystemMessage(`Nova AI participation mode set to: ${mode}`);
            } else {
                addSystemMessage('Nova AI is not available. Please ensure nova-chat-monitor.js is loaded correctly.');
            }
        }

        function setNovaPersonality(personality) {
            if (typeof novaChatMonitor !== 'undefined' && novaChatMonitor) {
                novaChatMonitor.setPersonality(personality);
                addSystemMessage(`Nova AI personality set to: ${personality}`);
            } else {
                addSystemMessage('Nova AI is not available. Please ensure nova-chat-monitor.js is loaded correctly.');
            }
        }

        // Close Nova menu when clicking outside
        document.addEventListener('click', function(event) {
            const novaMenu = document.getElementById('novaMenu');
            const novaButton = document.getElementById('novaAiButton');

            if (novaMenu && novaMenu.style.display === 'block' &&
                !novaMenu.contains(event.target) &&
                !novaButton.contains(event.target)) {
                novaMenu.style.display = 'none';
            }

            const voiceMenu = document.getElementById('voiceEffectMenu');
            const voiceButton = document.getElementById('voiceEffectButton');

            if (voiceMenu && voiceMenu.style.display === 'block' &&
                !voiceMenu.contains(event.target) &&
                !voiceButton.contains(event.target)) {
                voiceMenu.style.display = 'none';
            }

            const moreMenu = document.getElementById('moreOptionsMenu');
            const moreButton = document.getElementById('moreOptionsButton');

            if (moreMenu && moreMenu.style.display === 'block' &&
                !moreMenu.contains(event.target) &&
                !moreButton.contains(event.target)) {
                moreMenu.style.display = 'none';
            }
        });

        // Function to toggle the more options menu
        function toggleMoreOptionsMenu() {
            const menu = document.getElementById('moreOptionsMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }

        // Update camera status indicator
        function updateCameraStatusIndicator(isConnected) {
            const indicator = document.getElementById('cameraStatusIndicator');
            if (indicator) {
                indicator.style.backgroundColor = isConnected ? '#0be881' : '#ff4757';
            }
        }

        // Initial camera check when page loads
        window.addEventListener('load', async function() {
            // Check camera availability on page load
            const cameraAvailable = await checkCameraAvailability();
            updateCameraStatusIndicator(cameraAvailable);

            // Set up periodic camera status checks
            setInterval(async () => {
                const cameraAvailable = await checkCameraAvailability();
                updateCameraStatusIndicator(cameraAvailable);
            }, 10000); // Check every 10 seconds
        });


        // Enable bidirectional translation
        function setupBidirectionalTranslation() {
            const sourceInput = document.getElementById('translateInput');
            const targetOutput = document.getElementById('translateOutput');
            const sourceLang = document.getElementById('sourceLang');
            const targetLang = document.getElementById('targetLang');

            // Add event listeners for bidirectional translation
            sourceInput.addEventListener('input', function() {
                if (this.value) {
                    // Auto-translate when user types in source
                    performTranslation();
                }
            });

            // Add event listener for language swap
            sourceLang.addEventListener('change', function() {
                // Auto-translate when language is changed
                if (sourceInput.value) {
                    performTranslation();
                }
            });

            targetLang.addEventListener('change', function() {
                // Auto-translate when language is changed
                if (sourceInput.value) {
                    performTranslation();
                }
            });
        }

        // Swap source and target languages
        function swapLanguages() {
            const sourceLang = document.getElementById('sourceLang');
            const targetLang = document.getElementById('targetLang');
            const sourceInput = document.getElementById('translateInput');
            const targetOutput = document.getElementById('translateOutput');

            // Swap language selections
            const tempLang = sourceLang.value;
            sourceLang.value = targetLang.value;
            targetLang.value = tempLang;

            // Swap text values
            const tempText = sourceInput.value;
            sourceInput.value = targetOutput.value;
            targetOutput.value = tempText;

            // Perform translation with swapped languages
            performTranslation();
        }

        // Save conversation to server
        function saveConversation() {
            // Get all messages from the chat container
            const chatContainer = document.getElementById('chatContainer');
            const messages = [];

            // Extract message data
            const messageElements = chatContainer.querySelectorAll('.message');
            messageElements.forEach(element => {
                const username = element.querySelector('.username')?.textContent || '';
                const content = element.querySelector('.message-content')?.textContent || '';
                const timestamp = element.querySelector('.timestamp')?.textContent || '';
                const datestamp = element.querySelector('.datestamp')?.textContent || '';
                const type = element.classList.contains('sent') ? 'sent' : element.classList.contains('received') ? 'received' : 'system';

                messages.push({
                    username,
                    content,
                    timestamp,
                    datestamp,
                    type
                });
            });

            // Create conversation data
            const conversationData = {
                userId: currentUserId,
                username: currentUsername,
                contactId: selectedContact?.id || null,
                contactName: selectedContact?.username || null,
                messages,
                savedAt: new Date().toISOString()
            };

            // In a real implementation, this would send to the server
            // For now, we'll just save to localStorage
            localStorage.setItem('conversation_' + (selectedContact?.id || 'general'), JSON.stringify(conversationData));

            addSystemMessage('Conversation saved successfully!');
        }

        // Load conversation from server
        function loadConversation() {
            // In a real implementation, this would fetch from the server
            // For now, we'll load from localStorage
            const savedConversation = localStorage.getItem('conversation_' + (selectedContact?.id || 'general'));

            if (savedConversation) {
                const conversationData = JSON.parse(savedConversation);

                // Clear current chat
                document.getElementById('chatContainer').innerHTML = '';

                // Add messages to chat
                conversationData.messages.forEach(msg => {
                    if (msg.type === 'sent') {
                        addMessage(msg.username, msg.content, true);
                    } else if (msg.type === 'received') {
                        addMessage(msg.username, msg.content, false, true);
                    } else {
                        addSystemMessage(msg.content);
                    }
                });

                addSystemMessage(`Loaded conversation with ${conversationData.contactName || 'General'}`);
            } else {
                addSystemMessage('No saved conversation found');
            }
        }

        // Copy public ID to clipboard
        function copyPublicId() {
            const publicIdElement = document.getElementById('publicIdDisplay');
            const publicId = publicIdElement.textContent.trim();
            
            if (!publicId || publicId === 'Loading...' || publicId === 'Not available') {
                alert('Public ID is not available yet. Please wait for it to load.');
                return;
            }
            
            // Use modern Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(publicId).then(() => {
                    showCopyFeedback();
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    fallbackCopyText(publicId);
                });
            } else {
                // Fallback for older browsers
                fallbackCopyText(publicId);
            }
        }
        
        // Fallback copy method
        function fallbackCopyText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showCopyFeedback();
            } catch (err) {
                console.error('Fallback copy failed: ', err);
                alert('Failed to copy ID. Please manually select and copy it.');
            }
            document.body.removeChild(textArea);
        }
        
        // Show copy feedback message
        function showCopyFeedback() {
            const feedback = document.getElementById('copyFeedback');
            feedback.style.display = 'block';
            
            // Add animation
            feedback.style.animation = 'fadeIn 0.3s ease';
            
            setTimeout(() => {
                feedback.style.display = 'none';
            }, 2000);
        }
        
        // Refresh public ID from Firestore
        async function refreshPublicId() {
            const publicIdElement = document.getElementById('publicIdDisplay');
            const originalText = publicIdElement.textContent;
            
            publicIdElement.textContent = 'Loading...';
            publicIdElement.style.opacity = '0.7';
            
            try {
                // Fetch user data from Firestore
                const userDoc = await db.collection('users').doc(currentUserId).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    currentUserPublicId = userData.publicId;
                    publicIdElement.textContent = userData.publicId || 'Not available';
                    addSystemMessage('Public ID refreshed successfully!');
                } else {
                    // If not in Firestore, use localStorage
                    publicIdElement.textContent = currentUserPublicId || 'Not available';
                    addSystemMessage('Showing ID from local storage.');
                }
            } catch (error) {
                console.error('Error refreshing public ID:', error);
                publicIdElement.textContent = currentUserPublicId || 'Error loading';
                addSystemMessage('Using ID from local storage.');
            } finally {
                publicIdElement.style.opacity = '1';
            }
        }

        // Copy profile ID to clipboard (for profile card)
        function copyProfileId() {
            const publicId = currentUserPublicId;

            if (!publicId || publicId === 'Loading...') {
                alert('Public ID is not available yet. Please wait for it to load.');
                return;
            }

            // Use modern Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(publicId).then(() => {
                    showProfileCopyFeedback();
                }).catch(err => {
                    console.error('Failed to copy: ', err);
                    fallbackCopyProfileText(publicId);
                });
            } else {
                // Fallback for older browsers
                fallbackCopyProfileText(publicId);
            }
        }

        // Fallback copy method for profile card
        function fallbackCopyProfileText(text) {
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showProfileCopyFeedback();
            } catch (err) {
                console.error('Fallback copy failed: ', err);
                alert('Failed to copy ID. Please manually select and copy it.');
            }
            document.body.removeChild(textArea);
        }

        // Show copy feedback message for profile card
        function showProfileCopyFeedback() {
            const feedback = document.querySelector('.profile-card .copy-feedback');
            if (feedback) {
                feedback.classList.add('show');
                setTimeout(() => {
                    feedback.classList.remove('show');
                }, 2000);
            }
        }

        // Update profile card with user's public ID
        function updateProfileCard() {
            const profileIdDisplay = document.getElementById('profileIdDisplay');
            if (profileIdDisplay && currentUserPublicId) {
                profileIdDisplay.textContent = currentUserPublicId;
            }
        }

        // Variable to store search result temporarily
        let searchedUser = null;

        // Search for a user by public ID
        async function searchAndAddFriend() {
            const friendPublicId = document.getElementById('friendPublicId').value.trim();

            if (!friendPublicId) {
                alert('Please enter a friend\'s public ID');
                return;
            }

            // Validate ID format (6 characters)
            if (friendPublicId.length !== 6) {
                alert('Public ID must be 6 characters long');
                return;
            }

            // Check if it's yourself
            if (friendPublicId.toUpperCase() === currentUserPublicId.toUpperCase()) {
                alert('You cannot add yourself as a friend');
                console.warn(' [Search] Tried to search own ID:', friendPublicId);
                return;
            }

            // Show loading state
            const searchResults = document.getElementById('friendSearchResults');
            searchResults.style.display = 'block';
            document.getElementById('searchResultUsername').textContent = 'Searching...';
            document.getElementById('searchResultId').textContent = friendPublicId;

            console.log(' [Search] Searching for Friend ID:', friendPublicId.toUpperCase());
            console.log(' [Search] Your ID:', currentUserPublicId);
            console.log(' [Search] Searching for:', friendPublicId.toUpperCase());

            try {
                // Search for user in Firestore by public ID
                console.log(' [Firestore] Querying Firestore collection "users"...');
                const usersSnapshot = await db.collection('users')
                    .where('publicId', '==', friendPublicId.toUpperCase())
                    .limit(1)
                    .get();

                if (usersSnapshot.empty) {
                    console.warn(' [Search] Friend ID not found in database:', friendPublicId.toUpperCase());
                    document.getElementById('searchResultUsername').textContent = 'User not found';
                    document.getElementById('searchResultId').textContent = friendPublicId;
                    searchedUser = null;
                    
                    // Show helpful message
                    addSystemMessage(` User with ID "${friendPublicId.toUpperCase()}" not found. Please check the ID and try again.`);
                    return;
                }

                const userData = usersSnapshot.docs[0].data();
                const userId = usersSnapshot.docs[0].id;

                console.log(' [Search] User found!');
                console.log('  - Username:', userData.username);
                console.log('  - User ID:', userId);
                console.log('  - Public ID:', userData.publicId);

                searchedUser = {
                    id: userId,
                    username: userData.username,
                    publicId: userData.publicId
                };

                // Display search result
                document.getElementById('searchResultUsername').textContent = userData.username;
                document.getElementById('searchResultId').textContent = userData.publicId;

                // Show success message
                addSystemMessage(` User "${userData.username}" found with ID: ${userData.publicId}`);

                // Check if already friends
                if (friends.some(f => f.id === userId)) {
                    console.log(' [Search] User is already your friend');
                    document.getElementById('searchResultUsername').textContent = userData.username + ' (Already your friend)';
                    searchedUser = null;
                    addSystemMessage(` ${userData.username} is already in your friends list`);
                    return;
                }

                // Check if friend request already sent
                if (friendRequests.some(r =>
                    r.toUserId === userId &&
                    r.fromUserId === currentUserId &&
                    r.status === 'pending'
                )) {
                    console.log(' [Search] Friend request already sent to this user');
                    document.getElementById('searchResultUsername').textContent = userData.username + ' (Request pending)';
                    searchedUser = null;
                    addSystemMessage(` Friend request to ${userData.username} is still pending`);
                    return;
                }

                console.log(' [Search] User is available to add as friend');
                addSystemMessage(` "${userData.username}" found! Click "Add Friend" to send a request.`);

            } catch (error) {
                console.error(' [Search] Critical Error:', error.message);
                console.error('  - Error code:', error.code);
                document.getElementById('searchResultUsername').textContent = 'Error searching user';
                searchedUser = null;
                addSystemMessage(` Error searching for user: ${error.message}`);
            }
        }

        // Confirm adding the searched user as a friend
        function confirmAddFriend() {
            if (!searchedUser) {
                alert('No valid user found to add');
                return;
            }

            console.log(' Sending friend request to:', searchedUser.username, '(' + searchedUser.id + ')');

            // Send friend request
            server.sendFriendRequest(searchedUser.id);

            console.log(' Success: Friend request sent! Waiting for acceptance...');

            // Hide search results
            document.getElementById('friendSearchResults').style.display = 'none';
            document.getElementById('friendPublicId').value = '';
            searchedUser = null;
        }

        // Add friend by public ID (legacy function - redirects to new search)
        function addFriendById() {
            searchAndAddFriend();
        }

        // Check if input is in phone number format
        function isPhoneNumberFormat(input) {
            // Simple check for phone number format (+ followed by digits)
            const phoneRegex = /^\+\d{10,15}$/; // + followed by 10-15 digits
            return phoneRegex.test(input);
        }

        // Add friend by phone number
        function addFriendByPhone(phoneNumber) {
            // In a real implementation, this would query the server for users with this phone
            // For simulation, we'll check if any user has this phone number associated
            let targetUser = getUserByPhoneNumber(phoneNumber);

            if (!targetUser) {
                alert('User with this phone number not found. Make sure the user has registered their phone number.');
                return;
            }

            // Check if it's already a friend
            if (friends.some(f => f.id === targetUser.id)) {
                alert('This user is already your friend');
                return;
            }

            // Check if already sent a request to this user
            if (friendRequests.some(r =>
                r.fromUserId === currentUserId &&
                r.toUserId === targetUser.id &&
                r.status === 'pending'
            )) {
                alert('You have already sent a friend request to this user');
                return;
            }

            // Send friend request to the user
            server.sendFriendRequest(targetUser.id);

            addSystemMessage(`Friend request sent to user with phone: ${phoneNumber}`);
        }

        // Function to register phone number for current user
        function registerPhoneNumber() {
            const phoneInput = prompt('Enter your phone number (format: +[country code][number]):');

            if (!phoneInput) {
                return; // User cancelled
            }

            if (!isPhoneNumberFormat(phoneInput)) {
                alert('Invalid phone number format. Please use: +[country code][number] (e.g., +21622007232 for Tunisian numbers)');
                return;
            }

            // Update current user's profile with phone number
            if (currentUser) {
                currentUser.phoneNumber = phoneInput;

                // Update in localStorage
                const storedUser = JSON.parse(localStorage.getItem('currentUser'));
                storedUser.phoneNumber = phoneInput;
                localStorage.setItem('currentUser', JSON.stringify(storedUser));

                addSystemMessage(`Phone number ${phoneInput} registered successfully! Others can now find you using this number.`);
            } else {
                alert('Please log in first before registering your phone number.');
            }
        }

        // Function to get user by phone number
        function getUserByPhoneNumber(phoneNumber) {
            // Check friends first
            let user = friends.find(f => f.phoneNumber === phoneNumber);
            if (user) return user;

            // Then check contacts
            user = contacts.find(c => c.phoneNumber === phoneNumber);
            if (user) return user;

            return null;
        }

        // Function to add test friends for testing purposes
        function addTestFriends() {
            // Create some test friends
            const testFriends = [
                {
                    id: 'test1',
                    publicId: 'TST001',
                    username: 'Test Friend 1',
                    status: 'online',
                    addedAt: new Date().toISOString(),
                    displayName: 'TF1'
                },
                {
                    id: 'test2',
                    publicId: 'TST002',
                    username: 'Test Friend 2',
                    status: 'online',
                    addedAt: new Date().toISOString(),
                    displayName: 'TF2'
                },
                {
                    id: 'test3',
                    publicId: 'TST003',
                    username: 'Test Friend 3',
                    status: 'offline',
                    addedAt: new Date().toISOString(),
                    displayName: 'TF3'
                },
                {
                    id: 'test4',
                    publicId: 'TST004',
                    username: 'Test Friend 4',
                    status: 'online',
                    addedAt: new Date().toISOString(),
                    displayName: 'TF4',
                    phoneNumber: '+21612345678' // Example Tunisian number
                }
            ];

            // Add each test friend if they don't already exist
            let addedCount = 0;
            testFriends.forEach(testFriend => {
                // Check if friend already exists
                const exists = friends.some(f => f.id === testFriend.id);
                if (!exists) {
                    friends.push(testFriend);
                    addedCount++;
                }
            });

            // Save to localStorage
            saveData();

            // Update the contacts list to reflect changes
            renderContacts();
            updateFriendsMenuList();

            addSystemMessage(`Added ${addedCount} test friends to your friend list. Ready for testing!`);
        }

        // Function to add specific test friends directly
        function addSpecificTestFriends() {
            // Check if we already have test friends to avoid duplicates
            const hasTestFriends = friends.some(f => f.id.startsWith('test'));

            if (hasTestFriends) {
                // If we already have test friends, just update the display
                renderContacts();
                updateFriendsMenuList();
                return;
            }

            // Add 4 specific test friends
            const specificTestFriends = [
                {
                    id: 'test_friend_001',
                    publicId: 'MON001',
                    username: 'Ahmed Tunisia',
                    status: 'online',
                    addedAt: new Date().toISOString(),
                    displayName: 'Ahmed TN',
                    phoneNumber: '+21622007232' // Your Tunisian number
                },
                {
                    id: 'test_friend_002',
                    publicId: 'MON002',
                    username: 'Fatma Test',
                    status: 'online',
                    addedAt: new Date().toISOString(),
                    displayName: 'Fatma T',
                    phoneNumber: '+21698765432' // Example Tunisian number
                },
                {
                    id: 'test_friend_003',
                    publicId: 'MON003',
                    username: 'Karim Demo',
                    status: 'away',
                    addedAt: new Date().toISOString(),
                    displayName: 'Karim D',
                    phoneNumber: '+21655443322' // Example Tunisian number
                },
                {
                    id: 'test_friend_004',
                    publicId: 'MON004',
                    username: 'Leila Chat',
                    status: 'online',
                    addedAt: new Date().toISOString(),
                    displayName: 'Leila C',
                    phoneNumber: '+21611223344' // Example Tunisian number
                }
            ];

            // Add the specific test friends
            specificTestFriends.forEach(friend => {
                // Check if friend already exists
                const exists = friends.some(f => f.id === friend.id);
                if (!exists) {
                    friends.push(friend);
                }
            });

            // Save to localStorage
            saveData();

            // Update the contacts list to reflect changes
            renderContacts();
            updateFriendsMenuList();
        }

        // Quick join action - allows joining via QR code, phone, or ID
        function quickJoinAction() {
            const joinMethod = prompt('How would you like to join someone?\n\n1. Enter phone number (format: +[country code][number])\n2. Enter public ID (6 characters)\n3. Scan QR code (coming soon)\n\nEnter your choice (phone number, public ID, or "qr" for QR code):');

            if (!joinMethod) {
                return; // User cancelled
            }

            // Check if it's a phone number format
            if (isPhoneNumberFormat(joinMethod)) {
                addFriendByPhone(joinMethod);
                return;
            }

            // Check if it's a QR code request
            if (joinMethod.toLowerCase() === 'qr') {
                alert('QR code scanning functionality coming soon! For now, please use phone number or public ID.');
                return;
            }

            // Assume it's a public ID
            if (joinMethod.length === 6) {
                // Temporarily set the friendPublicId field and call addFriendById
                document.getElementById('friendPublicId').value = joinMethod;
                addFriendById();
                return;
            }

            alert('Invalid format. Please enter:\n- A phone number in format: +[country code][number]\n- A 6-character public ID\n- Or "qr" for QR code (coming soon)');
        }

        // Initialize
        window.onload = function() {
            // Add a creepy sound effect on load (optional)
            // Uncomment the next lines if you want to add a creepy sound
            /*
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFd2xqZ2VlZ2lucHV3fYSLjI6Qk5CMioeAfXl1cG1rbGttbnJ3fYOMlJmcm5qXlI+Jh4F9eHNwbGpra2xtdHd/g4yVm52empmVlI6JhoB8eHFvbGppaGZjYF1cW1lXVVRTUlFQT05MS0pJSEdGRURDQkFAPz49PDs6OTg3NjU0MzIxMC8uLSwrKikoJyYlJCMiISAfHh0cGxoZGBcWFRQTEhEQDw4NDAsKCQgHBgUEAwIBAA==');
            audio.play().catch(e => console.log("Audio play failed:", e));
            */

            // Add a creepy effect to the header
            const header = document.querySelector('.header');
            header.classList.add('glow');

            // Ensure container becomes visible after animation completes
            setTimeout(() => {
                const container = document.querySelector('.container');
                if (container) {
                    container.classList.add('animation-complete');
                }
            }, 1800); // Slightly after the animation duration

            // Check if user is already logged in
            const storedUserStr = localStorage.getItem('currentUser');
            if (storedUserStr) {
                const storedUser = JSON.parse(storedUserStr);
                currentUserId = storedUser.id;

                // Handle case where publicId might not exist in older user records
                if (!storedUser.publicId) {
                    // Generate a new public ID for the user
                    const newPublicId = generatePublicId();
                    storedUser.publicId = newPublicId;

                    // Update the stored user object
                    localStorage.setItem('currentUser', JSON.stringify(storedUser));

                    currentUserPublicId = newPublicId;
                } else {
                    currentUserPublicId = storedUser.publicId;
                }

                currentUsername = translator.advancedDecode(storedUser.username);

                // Show chat area
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('chatArea').classList.remove('hidden');

                // Connect to simulated server
                server.connect();

                addSystemMessage(`Welcome back to Monster Browser chat, ${currentUsername}! Your public ID is ${currentUserPublicId}. Share this ID with friends to connect.`);

                // Update the public ID display in settings and profile card after a short delay
                setTimeout(async function() {
                    const publicIdDisplay = document.getElementById('publicIdDisplay');
                    if (publicIdDisplay) {
                        // Try to fetch from Firestore first
                        try {
                            const userDoc = await db.collection('users').doc(currentUserId).get();
                            if (userDoc.exists) {
                                const userData = userDoc.data();
                                currentUserPublicId = userData.publicId;
                                publicIdDisplay.textContent = userData.publicId;
                                // Update profile card
                                updateProfileCard();
                            } else {
                                publicIdDisplay.textContent = currentUserPublicId || 'Not available';
                                updateProfileCard();
                            }
                        } catch (error) {
                            console.error('Error fetching public ID from Firestore:', error);
                            publicIdDisplay.textContent = currentUserPublicId || 'Not available';
                            updateProfileCard();
                        }
                    } else {
                        // Update profile card even if settings display doesn't exist
                        updateProfileCard();
                    }
                }, 100);

                // Add specific test friends for testing
                addSpecificTestFriends();
            } else {
                // If no user is logged in, ensure the public ID display shows appropriately
                setTimeout(function() {
                    const publicIdDisplay = document.getElementById('publicIdDisplay');
                    if (publicIdDisplay) {
                        publicIdDisplay.textContent = 'Log in to see your ID';
                    }
                }, 100);
            }

            // Load customizations if saved
            const savedCustomTheme = localStorage.getItem('customTheme');
            if (savedCustomTheme) {
                const theme = JSON.parse(savedCustomTheme);
                document.getElementById('themeColor').value = theme.themeColor;
                document.getElementById('bgColor').value = theme.bgColor;
            }


            // Add a subtle breathing effect to the container after the entrance animation
            setTimeout(() => {
                const container = document.querySelector('.container');
                if (container) {
                    container.style.animation = 'breathing 8s infinite';
                }
            }, 1600);
        };

        // Handle file upload with preview
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Show the file preview container
            document.getElementById('filePreviewContainer').style.display = 'block';

            // Create a preview based on file type
            const previewContainer = document.getElementById('filePreview');
            previewContainer.innerHTML = '';

            if (file.type.startsWith('image/')) {
                // Create image preview
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.style.maxWidth = '50px';
                img.style.maxHeight = '50px';
                img.style.borderRadius = '4px';

                const fileInfo = document.createElement('div');
                fileInfo.innerHTML = `
                    <div style="font-size: 0.9em; color: #e0e0e0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        <i class="fas fa-image" style="margin-right: 5px;"></i>${file.name}
                    </div>
                    <div style="font-size: 0.8em; color: #aaa;">${formatFileSize(file.size)}</div>
                `;

                previewContainer.appendChild(img);
                previewContainer.appendChild(fileInfo);
            } else {
                // Create generic file preview
                const fileInfo = document.createElement('div');
                fileInfo.innerHTML = `
                    <div style="font-size: 0.9em; color: #e0e0e0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        <i class="fas fa-file" style="margin-right: 5px;"></i>${file.name}
                    </div>
                    <div style="font-size: 0.8em; color: #aaa;">${formatFileSize(file.size)}</div>
                `;

                previewContainer.appendChild(fileInfo);
            }

            // Store the file for later use
            window.selectedFile = file;
        }

        // Remove selected file
        function removeSelectedFile() {
            document.getElementById('filePreviewContainer').style.display = 'none';
            document.getElementById('filePreview').innerHTML = '';
            document.getElementById('fileInput').value = '';
            window.selectedFile = null;
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Send file message
        function sendSelectedFile() {
            if (!window.selectedFile) return;

            const file = window.selectedFile;

            if (!selectedContact) {
                alert('Please select a contact to send a file to');
                return;
            }

            // Check if selected contact is a friend
            const isFriend = friends.some(f => f.id === selectedContact.id);
            if (!isFriend) {
                alert('You can only send files to friends. Send a friend request first.');
                return;
            }

            // Create a file message
            const fileInfo = {
                name: file.name,
                size: formatFileSize(file.size),
                type: file.type,
                timestamp: new Date().toISOString()
            };

            // Create a file message
            const fileMessage = `[FILE] ${fileInfo.name} (${fileInfo.size})`;

            // Add file message to chat
            addMessage(currentUsername, fileMessage, true);

            // In a real implementation, you would upload the file to the server
            // For now, we'll just simulate the upload
            simulateFileUpload(file);

            // Remove the file from preview
            removeSelectedFile();
        }

        // Override the original handleFileUpload to also send the file
        const originalHandleFileUpload = handleFileUpload;
        handleFileUpload = function(event) {
            originalHandleFileUpload(event);
            // Automatically send the file after preview
            // Comment out the next line if you want to require manual sending
            // sendSelectedFile();
        };


        // Function to fix layout issues when messages are added
        function fixLayoutOnMessage() {
            // Use a slight delay to ensure DOM has updated
            setTimeout(() => {
                // Ensure the chat always scrolls to the bottom
                const chatContainer = document.getElementById('chatContainer');
                if (chatContainer) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            }, 10);
        }

        // Function to toggle the friends menu
        function toggleFriendsMenu() {
            const friendsMenu = document.getElementById('friendsMenu');
            const friendsMenuToggle = document.getElementById('friendsMenuToggle');

            if (friendsMenu.classList.contains('open')) {
                // Close the menu
                friendsMenu.classList.remove('open');
                friendsMenuToggle.style.display = 'flex'; // Show the toggle button
            } else {
                // Open the menu
                friendsMenu.classList.add('open');
                friendsMenuToggle.style.display = 'none'; // Hide the toggle button when menu is open
            }
        }

        // Function to close the friends menu
        function closeFriendsMenu() {
            const friendsMenu = document.getElementById('friendsMenu');
            const friendsMenuToggle = document.getElementById('friendsMenuToggle');

            friendsMenu.classList.remove('open');
            friendsMenuToggle.style.display = 'flex'; // Show the toggle button
        }

        // Function to update the friends list in the new menu
        function updateFriendsMenuList() {
            const container = document.getElementById('friendsMenuContainer');
            if (!container) return; // Exit if container doesn't exist

            container.innerHTML = '';

            // === ADD CURRENT USER PROFILE AT THE TOP ===
            const myProfileCard = document.createElement('div');
            myProfileCard.className = 'contact-item';
            myProfileCard.style.background = 'linear-gradient(135deg, rgba(139, 0, 0, 0.3), rgba(75, 0, 0, 0.4))';
            myProfileCard.style.border = '2px solid #ffd700';
            myProfileCard.style.marginBottom = '15px';
            myProfileCard.style.position = 'relative';

            const myInitial = (currentUsername || 'Me').charAt(0).toUpperCase();

            myProfileCard.innerHTML = `
                <div class="contact-avatar" style="background: linear-gradient(135deg, #ffd700, #ff8c00); color: #000;">
                    ${myInitial}
                </div>
                <div class="contact-info" style="flex: 1;">
                    <div class="contact-name" style="color: #ffd700; font-weight: bold;">
                        ${currentUsername || 'Me'} <span style="color: #4CAF50; font-size: 0.8em;">(Me)</span>
                        <i class="fas fa-crown" style="color: #ffd700; font-size: 0.7em; margin-left: 5px;" title="My Profile"></i>
                    </div>
                    <div class="contact-status">
                        <span class="status-indicator-small status-online"></span>
                        <span style="color: #4CAF50;">Online</span>
                        <span style="margin-left: 10px; color: #aaa; font-size: 0.85em;">ID: ${currentUserPublicId || 'N/A'}</span>
                    </div>
                </div>
                <button class="copy-id-btn-small" title="Copy ID" style="background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.85em; margin-left: 10px; display: flex; align-items: center; gap: 5px; transition: all 0.3s ease;">
                    <i class="fas fa-copy"></i>
                </button>
            `;

            // Add click handler to open chat with self
            myProfileCard.onclick = (e) => {
                // Don't open chat if copy button was clicked
                if (e.target.closest('.copy-id-btn-small')) return;
                
                // Open chat with self for testing
                openChatWithSelf();
            };

            // Add long-press functionality to copy ID
            let pressTimer;
            myProfileCard.addEventListener('mousedown', (e) => {
                if (e.target.closest('.copy-id-btn-small')) return;
                pressTimer = setTimeout(() => {
                    if (currentUserPublicId) {
                        copyProfileId();
                        addSystemMessage(`Your Public ID (${currentUserPublicId}) copied to clipboard!`);
                        navigator.vibrate?.(50); // Haptic feedback if supported
                    }
                }, 800); // 800ms long press
            });

            myProfileCard.addEventListener('mouseup', () => clearTimeout(pressTimer));
            myProfileCard.addEventListener('mouseleave', () => clearTimeout(pressTimer));
            myProfileCard.addEventListener('touchstart', (e) => {
                if (e.target.closest('.copy-id-btn-small')) return;
                pressTimer = setTimeout(() => {
                    if (currentUserPublicId) {
                        copyProfileId();
                        addSystemMessage(`Your Public ID (${currentUserPublicId}) copied to clipboard!`);
                        navigator.vibrate?.(50); // Haptic feedback if supported
                    }
                }, 800);
            }, {passive: true});

            myProfileCard.addEventListener('touchend', () => clearTimeout(pressTimer));

            // Add copy button click handler
            const copyBtn = myProfileCard.querySelector('.copy-id-btn-small');
            copyBtn.onclick = (e) => {
                e.stopPropagation();
                if (currentUserPublicId) {
                    copyProfileId();
                    addSystemMessage(`Your Public ID (${currentUserPublicId}) copied to clipboard!`);
                    
                    // Visual feedback on button
                    copyBtn.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                        copyBtn.style.transform = 'scale(1)';
                    }, 150);
                }
            };

            myProfileCard.style.cursor = 'pointer';
            myProfileCard.title = 'Click to chat with yourself (for testing) | Long-press or click copy button to copy ID';

            container.appendChild(myProfileCard);
            // =========================================

            if (currentTab === 'friends') {
                // Show friends only
                if (friends.length === 0) {
                    container.innerHTML = '<div class="contact-item"><div class="contact-info"><div class="contact-name">No friends yet</div><div class="contact-status">Send friend requests to connect</div></div></div>';
                    return;
                }

                friends.forEach(friend => {
                    const contactElement = document.createElement('div');
                    contactElement.className = 'contact-item';
                    // Use display name if available, otherwise use original username
                    const displayName = friend.displayName || friend.username;

                    // Determine status color based on online status
                    const statusClass = friend.status === 'online' ? 'status-online' : 'status-offline';
                    const statusText = friend.status === 'online' ? 'Online' : 'Offline';

                    contactElement.innerHTML = `
                        <div class="contact-avatar">${displayName.charAt(0)}</div>
                        <div class="contact-info">
                            <div class="contact-name">${displayName} ${friend.displayName ? `<i class="fas fa-star" title="Renamed from ${friend.username}" style="color: gold; font-size: 0.7em; margin-left: 5px;"></i>` : ''}</div>
                            <div class="contact-status">
                                <span class="status-indicator-small ${statusClass}"></span>
                                ${statusText}
                            </div>
                        </div>
                    `;

                    // Add right-click context menu for renaming
                    contactElement.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showRenameMenu(e, friend);
                    });

                    contactElement.onclick = () => {
                        // Deselect all contacts
                        document.querySelectorAll('.contact-item').forEach(item => {
                            item.classList.remove('selected');
                        });

                        // Select this contact
                        contactElement.classList.add('selected');

                        selectedContact = friend;
                        selectedChat = friend.id;

                        // Initialize private chat session with proper ID verification
                        console.log(' [Chat] Opening chat with friend...');
                        console.log('  - Your ID (currentUserId):', currentUserId);
                        console.log('  - Friend ID (friend.id):', friend.id);
                        console.log('  - Your Public ID:', currentUserPublicId);
                        console.log('  - Friend Public ID:', friend.publicId || 'N/A');
                        
                        const chatId = generateChatId(currentUserId, friend.id);
                        console.log('  - Generated Chat ID:', chatId);
                        
                        listenForMessages(chatId);

                        addSystemMessage(`Selected friend: ${displayName}. Send a message to start chatting.`);

                        // Close the menu after selecting a contact
                        closeFriendsMenu();
                    };

                    container.appendChild(contactElement);
                });
            } else {
                // Show all contacts (friends + non-friends)
                // Show friends first
                friends.forEach(friend => {
                    const contactElement = document.createElement('div');
                    contactElement.className = 'contact-item';
                    // Use display name if available, otherwise use original username
                    const displayName = friend.displayName || friend.username;

                    // Determine status color based on online status
                    const statusClass = friend.status === 'online' ? 'status-online' : 'status-offline';
                    const statusText = friend.status === 'online' ? 'Online' : 'Offline';

                    contactElement.innerHTML = `
                        <div class="contact-avatar">${displayName.charAt(0)}</div>
                        <div class="contact-info">
                            <div class="contact-name">${displayName} ${friend.displayName ? `<i class="fas fa-star" title="Renamed from ${friend.username}" style="color: gold; font-size: 0.7em; margin-left: 5px;"></i>` : ''}</div>
                            <div class="contact-status">
                                <span class="status-indicator-small ${statusClass}"></span>
                                ${statusText}
                            </div>
                        </div>
                    `;

                    // Add right-click context menu for renaming
                    contactElement.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        showRenameMenu(e, friend);
                    });

                    contactElement.onclick = () => {
                        // Deselect all contacts
                        document.querySelectorAll('.contact-item').forEach(item => {
                            item.classList.remove('selected');
                        });

                        // Select this contact
                        contactElement.classList.add('selected');

                        selectedContact = friend;
                        selectedChat = friend.id;
                        addSystemMessage(`Selected friend: ${displayName}. Send a message to start chatting.`);

                        // Close the menu after selecting a contact
                        closeFriendsMenu();
                    };

                    container.appendChild(contactElement);
                });

                // Then show other contacts
                contacts.forEach(contact => {
                    // Skip if already a friend
                    if (friends.some(f => f.id === contact.id)) return;

                    const contactElement = document.createElement('div');
                    contactElement.className = 'contact-item';
                    contactElement.innerHTML = `
                        <div class="contact-avatar">${contact.username.charAt(0)}</div>
                        <div class="contact-info">
                            <div class="contact-name">${contact.username}</div>
                            <div class="contact-status">
                                <span class="status-indicator-small status-${contact.status}"></span>
                                ${contact.status.charAt(0).toUpperCase() + contact.status.slice(1)}
                            </div>
                        </div>
                  `;

                    contactElement.onclick = () => {
                        // Deselect all contacts
                        document.querySelectorAll('.contact-item').forEach(item => {
                            item.classList.remove('selected');
                        });

                        // Select this contact
                        contactElement.classList.add('selected');

                        selectedContact = contact;
                        addSystemMessage(`Selected contact: ${contact.username}. Send a friend request to start chatting.`);

                        // Close the menu after selecting a contact
                        closeFriendsMenu();
                    };

                    container.appendChild(contactElement);
                });
            }
        }

        // Function to handle tab switching in the friends menu
        function setupFriendsMenuTabs() {
            const tabs = document.querySelectorAll('.friends-menu-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs
                    tabs.forEach(t => t.classList.remove('active'));

                    // Add active class to clicked tab
                    this.classList.add('active');

                    // Update current tab
                    currentTab = this.getAttribute('data-tab');

                    // Re-render contacts
                    updateFriendsMenuList();
                });
            });
        }

        // Run once when page loads
        window.addEventListener('load', function() {
            // Set up the friends menu toggle button
            const friendsMenuToggle = document.getElementById('friendsMenuToggle');
            if (friendsMenuToggle) {
                friendsMenuToggle.addEventListener('click', toggleFriendsMenu);
            }

            // Set up the close button for the friends menu
            const closeFriendsMenuBtn = document.getElementById('closeFriendsMenu');
            if (closeFriendsMenuBtn) {
                closeFriendsMenuBtn.addEventListener('click', closeFriendsMenu);
            }

            // Set up the friends menu tabs
            setupFriendsMenuTabs();

            // Initially hide the toggle button if the menu is open
            const friendsMenu = document.getElementById('friendsMenu');
            if (friendsMenu && friendsMenu.classList.contains('open')) {
                friendsMenuToggle.style.display = 'none';
            }
        });

        // Update the renderContacts function to work with the new menu
        const originalRenderContacts = renderContacts;
        renderContacts = function() {
            // Update the friends menu list
            updateFriendsMenuList();

            // Also update the original contacts container if needed
            originalRenderContacts.call(this);
        };

        // Function to add test friends for testing purposes
        function addTestFriends() {
            // Create some test friends
            const testFriends = [
                {
                    id: 'test_friend_001',
                    publicId: 'MON001',
                    username: 'Ahmed Tunisia',
                    status: 'online',
                    addedAt: new Date().toISOString(),
                    displayName: 'Ahmed TN',
                    phoneNumber: '+21622007232' // Your Tunisian number
                },
                {
                    id: 'test_friend_002',
                    publicId: 'MON002',
                    username: 'Fatma Test',
                    status: 'online',
                    addedAt: new Date().toISOString(),
                    displayName: 'Fatma T',
                    phoneNumber: '+21698765432' // Example Tunisian number
                },
                {
                    id: 'test_friend_003',
                    publicId: 'MON003',
                    username: 'Karim Demo',
                    status: 'away',
                    addedAt: new Date().toISOString(),
                    displayName: 'Karim D',
                    phoneNumber: '+21655443322' // Example Tunisian number
                },
                {
                    id: 'test_friend_004',
                    publicId: 'MON004',
                    username: 'Leila Chat',
                    status: 'online',
                    addedAt: new Date().toISOString(),
                    displayName: 'Leila C',
                    phoneNumber: '+21611223344' // Example Tunisian number
                }
            ];

            // Add each test friend if they don't already exist
            let addedCount = 0;
            testFriends.forEach(testFriend => {
                // Check if friend already exists
                const exists = friends.some(f => f.id === testFriend.id);
                if (!exists) {
                    friends.push(testFriend);
                    addedCount++;
                }
            });

            // Save to localStorage
            if (typeof saveData !== 'undefined') {
                saveData();
            }

            // Update the contacts list to reflect changes
            if (typeof renderContacts !== 'undefined') {
                renderContacts();
            }

            if (typeof updateFriendsMenuList !== 'undefined') {
                updateFriendsMenuList();
            }

            // Show confirmation message
            if (typeof addSystemMessage !== 'undefined') {
                addSystemMessage(`Added ${addedCount} test friends to your friend list. Ready for testing!`);
            } else {
                alert(`Added ${addedCount} test friends to your friend list. Ready for testing!`);
            }
        }

        // DISABLED: Nova AI learning and auto-response functions
        // All Nova AI functionality has been turned off for full user control

        // Original sendMessage function (no Nova AI interference)
        // Messages are sent directly without AI observation or logging

        // Original addMessage function (no Nova AI observation)
        // Messages are displayed without AI interference

        // Enhanced system message function to include layout fix
        const originalAddSystemMessage = addSystemMessage;
        addSystemMessage = function(message) {
            // Call the original function
            const result = originalAddSystemMessage.apply(this, arguments);

            // Apply layout fix after message is added
            fixLayoutOnMessage();

            return result;
        };

        /*
        ============================================
        FIRESTORE SETUP INSTRUCTIONS
        ============================================
        
        1. FIRESTORE SECURITY RULES:
        Go to Firebase Console > Firestore Database > Rules and add:

        rules_version = '2';
        service cloud.firestore {
          match /databases/{database}/documents {
            // Users collection - readable by everyone, writable by owner
            match /users/{userId} {
              allow read: if true;
              allow write: if request.auth == null || request.resource.data.id == userId;
            }
            
            // Messages collection - only accessible by chat participants
            match /messages/{messageId} {
              allow read: if true;  // For demo - restrict in production
              allow create: if true; // For demo - restrict in production
            }
          }
        }

        2. FIRESTORE INDEXES:
        Create the following composite indexes in Firebase Console > Firestore > Indexes:
        
        - Collection: messages
          Fields: chatId (Ascending), timestamp (Ascending)
          Query scope: Collection

        3. FIREBASE CONFIGURATION:
        Update the firebaseConfig object at the top of this file with your actual Firebase project credentials.

        4. HOW THE FRIEND SYSTEM WORKS:
        - Each user gets a unique 6-character public ID
        - Users can search for friends by entering their public ID
        - When a friend request is accepted, a private chat session is created
        - Messages are stored with chatId = "chat_{userId1}_{userId2}" (sorted alphabetically)
        - Only users in the chat can see messages for that chatId
        ============================================
        */
    </script>
</body>
</html>